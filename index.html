<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="siteTitle">Tee & Me - Our Story</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- i18next CDNs -->
    <script src="https://unpkg.com/i18next@23.11.5/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@7.1.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- External Translations -->
    <script src="xh_translations.js"></script>
    <style>
        /* Custom CSS for layout and aesthetics */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #videoBackground {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.9);
        }
        nav {
            position: fixed;
            width: 100%;
            z-index: 10;
            background-color: rgba(255, 192, 203, 0.9); /* Pink accent */
        }
        .content-area-wrapper {
            position: fixed;
            top: 0;
            width: 100%;
            height: calc(100% - 120px); /* Adjust based on header + nav height */
            margin-top: 120px; /* Adjust based on header + nav height */
        }
        .content-section {
            height: 100%;
            overflow: hidden;
            display: none;
        }
        .content-section.active {
            display: flex;
        }
        .sub-content {
            overflow-y: auto;
            max-height: calc(100% - 50px); /* Account for sub-nav height */
        }
        .carousel {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
        }
        .carousel::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }
        .carousel-item {
            flex: 0 0 auto;
            margin-right: 1rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
        }
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 20;
        }
        #playlistButton {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 40;
            background-color: #ff69b4; /* Hot pink */
            color: white;
            padding: 0.75rem;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- Video Background -->
    <video id="videoBackground" autoplay loop muted>
        <source src="assets/videos/background.mp4" type="video/mp4">
    </video>

    <!-- Header -->
    <header class="p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold" data-i18n="siteTitle">Tee & Me - Our Story</h1>
        <div>
            <button id="langEN" class="px-2 py-1 bg-pink-500 text-white rounded" data-i18n="langEN">EN</button>
            <button id="langXH" class="px-2 py-1 bg-gray-500 text-white rounded" data-i18n="langXH">XH</button>
        </div>
    </header>

    <!-- Navigation -->
    <nav id="mainNav" class="p-4 flex justify-around">
        <button class="nav-tab bg-pink-500 text-white px-4 py-2 rounded" data-section="overview" data-i18n="navOverview">Overview</button>
        <button class="nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-section="analysis" data-i18n="navAnalysis">Analysis Hub</button>
        <button class="nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-section="media" data-i18n="navMedia">Media & Travel</button>
        <button class="nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-section="connect" data-i18n="navConnect">Connect & Resolve</button>
        <button class="nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-section="lifesync" data-i18n="navLifeSync">LifeSync & Fun</button>
    </nav>

    <!-- Content Area -->
    <div class="content-area-wrapper">
        <div class="content-area">
            <!-- Overview Section -->
            <section id="overview" class="content-section flex flex-col md:flex-row p-4 bg-white bg-opacity-90">
                <div class="w-full md:w-1/2 p-4">
                    <h2 class="text-xl font-bold mb-4" data-i18n="overviewTitle">Our Journey Snapshot</h2>
                    <!-- Dashboard -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-pink-100 p-4 rounded">
                            <h3 data-i18n="metricAffection">Affection Level</h3>
                            <p id="metricAffection">N/A</p>
                        </div>
                        <div class="bg-pink-100 p-4 rounded">
                            <h3 data-i18n="metricSupport">Support Score</h3>
                            <p id="metricSupport">N/A</p>
                        </div>
                        <div class="bg-pink-100 p-4 rounded">
                            <h3 data-i18n="metricFood">Food Prep</h3>
                            <p id="metricFood">N/A</p>
                        </div>
                        <div class="bg-pink-100 p-4 rounded">
                            <h3 data-i18n="metricSafety">Safety/Security</h3>
                            <p id="metricSafety">N/A</p>
                        </div>
                    </div>
                    <!-- Special Song -->
                    <div class="mb-4">
                        <h3 data-i18n="specialSong">Our Special Song</h3>
                        <p>"Thank You Baby! (For Makin' Someday Come So Soon)"</p>
                        <a href="https://youtu.be/DOcCQ-kC4iE?si=DrJURhh0p86ce7yt" target="_blank" class="text-pink-500" data-i18n="listen">Listen</a>
                    </div>
                    <!-- Timeline Carousel -->
                    <h3 data-i18n="timelineTitle">Quick Timeline</h3>
                    <div id="timelineCarousel" class="carousel">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div class="w-full md:w-1/2 p-4">
                    <!-- Image Carousel -->
                    <div id="imageCarousel" class="carousel mb-4">
                        <!-- Populated dynamically -->
                    </div>
                    <!-- Dashboard Chart -->
                    <select id="dashboardMetricSelect" class="mb-2 p-2 border rounded">
                        <option value="affection" data-i18n="metricAffection">Affection Level</option>
                        <option value="support" data-i18n="metricSupport">Support Score</option>
                        <option value="food" data-i18n="metricFood">Food Prep</option>
                        <option value="safety" data-i18n="metricSafety">Safety/Security</option>
                    </select>
                    <canvas id="dashboardChart"></canvas>
                </div>
            </section>

            <!-- Analysis Hub Section -->
            <section id="analysis" class="content-section flex flex-col p-4 bg-white bg-opacity-90">
                <div class="sub-nav-tabs flex mb-4">
                    <button class="sub-nav-tab bg-pink-500 text-white px-4 py-2 rounded" data-subsection="tracking" data-i18n="tabTracking">Tracking</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="contributions" data-i18n="tabContributions">Contributions</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="reinforcement" data-i18n="tabReinforcement">Reinforcement</button>
                </div>
                <div id="tracking" class="sub-content hidden">
                    <select id="trackingMetricSelect" class="mb-2 p-2 border rounded">
                        <!-- Populated dynamically -->
                    </select>
                    <canvas id="trackingChart"></canvas>
                </div>
                <div id="contributions" class="sub-content hidden">
                    <select id="contributionFilterWeek" class="mb-2 p-2 border rounded">
                        <!-- Populated dynamically -->
                    </select>
                    <table class="w-full border">
                        <thead>
                            <tr>
                                <th data-i18n="parameter">Parameter</th>
                                <th data-i18n="salatiso">Salatiso</th>
                                <th data-i18n="tee">Tee</th>
                                <th data-i18n="notes">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="contributionsTableBody"></tbody>
                    </table>
                </div>
                <div id="reinforcement" class="sub-content hidden">
                    <table class="w-full border">
                        <thead>
                            <tr>
                                <th data-i18n="wordAction">Word/Action</th>
                                <th data-i18n="purpose">Purpose</th>
                                <th data-i18n="salatiso">Salatiso</th>
                                <th data-i18n="tee">Tee</th>
                                <th data-i18n="joint">Joint</th>
                            </tr>
                        </thead>
                        <tbody id="reinforcementTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Media & Travel Hub Section -->
            <section id="media" class="content-section flex flex-col p-4 bg-white bg-opacity-90">
                <div class="sub-nav-tabs flex mb-4">
                    <button class="sub-nav-tab bg-pink-500 text-white px-4 py-2 rounded" data-subsection="songs" data-i18n="tabSongs">Shared Songs</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="photos" data-i18n="tabPhotos">Photo Moments</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="visited" data-i18n="tabVisited">Visited</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="dream" data-i18n="tabDream">Dream Trips</button>
                </div>
                <div id="songs" class="sub-content hidden">
                    <div id="songsList" class="carousel">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div id="photos" class="sub-content hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Populated dynamically -->
                </div>
                <div id="visited" class="sub-content hidden">
                    <div id="visitedList" class="carousel">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div id="dream" class="sub-content hidden">
                    <div id="dreamList" class="carousel">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </section>

            <!-- Connect & Resolve Section -->
            <section id="connect" class="content-section flex flex-col p-4 bg-white bg-opacity-90">
                <div class="sub-nav-tabs flex mb-4">
                    <button class="sub-nav-tab bg-pink-500 text-white px-4 py-2 rounded" data-subsection="feedback" data-i18n="tabFeedback">Feedback</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="actions" data-i18n="tabActions">Actions</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="logs" data-i18n="tabLogs">Logs</button>
                </div>
                <div id="feedback" class="sub-content hidden">
                    <form id="feedbackForm" class="mb-4">
                        <select id="feedbackSender" class="p-2 border rounded mb-2">
                            <option value="Salatiso" data-i18n="salatiso">Salatiso</option>
                            <option value="Tee" data-i18n="tee">Tee</option>
                        </select>
                        <select id="feedbackRecipient" class="p-2 border rounded mb-2">
                            <option value="Salatiso" data-i18n="salatiso">Salatiso</option>
                            <option value="Tee" data-i18n="tee">Tee</option>
                        </select>
                        <textarea id="feedbackMessage" class="w-full p-2 border rounded mb-2" data-i18n="[placeholder]feedbackPlaceholder"></textarea>
                        <button type="submit" class="bg-pink-500 text-white px-4 py-2 rounded" data-i18n="sendFeedback">Send Feedback</button>
                    </form>
                    <div id="feedbackLog" class="sub-content">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div id="actions" class="sub-content hidden">
                    <!-- Apology Form -->
                    <form id="apologyForm" class="mb-4">
                        <h3 data-i18n="makeApology">Make an Apology</h3>
                        <select id="apologySender" class="p-2 border rounded mb-2">
                            <option value="Salatiso" data-i18n="salatiso">Salatiso</option>
                            <option value="Tee" data-i18n="tee">Tee</option>
                        </select>
                        <textarea id="apologyMessage" class="w-full p-2 border rounded mb-2" data-i18n="[placeholder]apologyPlaceholder"></textarea>
                        <button type="submit" class="bg-pink-500 text-white px-4 py-2 rounded" data-i18n="submitApology">Submit Apology</button>
                    </form>
                    <!-- Other forms (Express Dissatisfaction, Book a Date, Termination) -->
                </div>
                <div id="logs" class="sub-content hidden">
                    <div id="actionLog" class="sub-content">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </section>

            <!-- LifeSync & Fun Section -->
            <section id="lifesync" class="content-section flex flex-col p-4 bg-white bg-opacity-90">
                <div class="sub-nav-tabs flex mb-4">
                    <button class="sub-nav-tab bg-pink-500 text-white px-4 py-2 rounded" data-subsection="compatibility" data-i18n="tabCompatibility">Compatibility</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="quizzes" data-i18n="tabQuizzes">Quizzes</button>
                    <button class="sub-nav-tab bg-gray-500 text-white px-4 py-2 rounded" data-subsection="reports" data-i18n="tabReports">LifeSync Reports</button>
                </div>
                <div id="compatibility" class="sub-content hidden">
                    <div class="mb-4">
                        <h3 data-i18n="astrologyTitle">Astrology Compatibility</h3>
                        <input id="salatisoBirthday" type="date" class="p-2 border rounded mb-2">
                        <input id="teeBirthday" type="date" class="p-2 border rounded mb-2">
                        <button id="checkCompatibility" class="bg-pink-500 text-white px-4 py-2 rounded" data-i18n="checkCompatibility">Check Compatibility</button>
                        <p id="compatibilityResult"></p>
                    </div>
                    <!-- Placeholder Tests -->
                    <div class="bg-pink-100 p-4 rounded">
                        <h3 data-i18n="valuesAlignment">Values Alignment</h3>
                        <button class="bg-gray-500 text-white px-4 py-2 rounded" data-i18n="startTest">Start Test</button>
                        <p data-i18n="comingSoon">Coming Soon!</p>
                    </div>
                </div>
                <div id="quizzes" class="sub-content hidden">
                    <p data-i18n="comingSoon">Coming Soon!</p>
                </div>
                <div id="reports" class="sub-content hidden">
                    <select id="reportPeriod" class="p-2 border rounded mb-2">
                        <option value="3months" data-i18n="last3Months">Last 3 Months</option>
                        <option value="all" data-i18n="allTime">All Time</option>
                    </select>
                    <button id="generateReport" class="bg-pink-500 text-white px-4 py-2 rounded" data-i18n="generateReport">Generate Report</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal cursor-pointer text-2xl">&times;</span>
            <div id="modalCarousel" class="carousel">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <span class="close-modal cursor-pointer text-2xl">&times;</span>
            <p id="alertMessage"></p>
            <button id="alertOK" class="bg-pink-500 text-white px-4 py-2 rounded" data-i18n="ok">OK</button>
        </div>
    </div>
    <div id="playlistModal" class="modal">
        <div class="modal-content">
            <span class="close-modal cursor-pointer text-2xl">&times;</span>
            <iframe id="playlistFrame" width="100%" height="400" frameborder="0"></iframe>
        </div>
    </div>

    <!-- Floating Playlist Button -->
    <button id="playlistButton" class="fa fa-music"></button>

    <!-- Footer -->
    <footer class="p-2 text-center">
        <p data-i18n="footer">© 2025 Tee & Me</p>
    </footer>

    <script>
        // Sample relationshipData
        const relationshipData = {
            playlistUrl: "https://music.youtube.com/playlist?list=PLXPU1hLJ2t0MZKrDGjGxk7vNlVeh9pX0C&si=ZPqinjcSRBsq8FZZ",
            photoFileNames: ["photo1.jpg", "photo2.jpg", "photo3.jpg"],
            weeks: [
                {
                    weekNumber: 1,
                    startDate: "2025-01-01",
                    contributions: {
                        affection: { salatiso: { score: 8, actions: ["Hugs"], notes: "" }, tee: { score: 7, actions: ["Kisses"], notes: "" } },
                        support: { salatiso: { score: 9, actions: ["Listening"], notes: "" }, tee: { score: 8, actions: ["Encouragement"], notes: "" } }
                    },
                    summaryKey: "week1Summary",
                    events: [
                        { type: "music", textKey: "sharedSong", songTitle: "Song 1", songUrl: "https://youtube.com", sharedBy: "Salatiso", originalMessage: "Loved this!" }
                    ]
                }
            ],
            reinforcementWords: [
                { word: "Thank you", purpose: "Gratitude", occurrences: { salatiso: [1], tee: [], joint: [] } }
            ],
            feedbackLog: [],
            actionLog: [],
            travelLog: [
                { type: "visited", destination: "Cape Town", dates: "2025-01-01", roles: { salatiso: "Planner", tee: "Navigator" }, highlights: "Table Mountain", photos: ["photo1.jpg"] },
                { type: "dream", destination: "Paris", notes: "Dream honeymoon" }
            ]
        };

        // i18next Initialization
        i18next
            .use(i18nextBrowserLanguageDetector)
            .init({
                resources: {
                    en: {
                        translation: {
                            siteTitle: "Tee & Me - Our Story",
                            langEN: "EN",
                            langXH: "XH",
                            navOverview: "Overview",
                            navAnalysis: "Analysis Hub",
                            navMedia: "Media & Travel",
                            navConnect: "Connect & Resolve",
                            navLifeSync: "LifeSync & Fun",
                            overviewTitle: "Our Journey Snapshot",
                            metricAffection: "Affection Level",
                            metricSupport: "Support Score",
                            metricFood: "Food Prep",
                            metricSafety: "Safety/Security",
                            specialSong: "Our Special Song",
                            listen: "Listen",
                            timelineTitle: "Quick Timeline",
                            tabTracking: "Tracking",
                            tabContributions: "Contributions",
                            tabReinforcement: "Reinforcement",
                            tabSongs: "Shared Songs",
                            tabPhotos: "Photo Moments",
                            tabVisited: "Visited",
                            tabDream: "Dream Trips",
                            tabFeedback: "Feedback",
                            tabActions: "Actions",
                            tabLogs: "Logs",
                            tabCompatibility: "Compatibility",
                            tabQuizzes: "Quizzes",
                            tabReports: "LifeSync Reports",
                            parameter: "Parameter",
                            salatiso: "Salatiso",
                            tee: "Tee",
                            notes: "Notes",
                            wordAction: "Word/Action",
                            purpose: "Purpose",
                            joint: "Joint",
                            feedbackPlaceholder: "Type your feedback...",
                            sendFeedback: "Send Feedback",
                            makeApology: "Make an Apology",
                            apologyPlaceholder: "Type your apology...",
                            submitApology: "Submit Apology",
                            astrologyTitle: "Astrology Compatibility",
                            checkCompatibility: "Check Compatibility",
                            valuesAlignment: "Values Alignment",
                            startTest: "Start Test",
                            comingSoon: "Coming Soon!",
                            last3Months: "Last 3 Months",
                            allTime: "All Time",
                            generateReport: "Generate Report",
                            ok: "OK",
                            footer: "© 2025 Tee & Me"
                        }
                    },
                    xh: xhosaTranslations // Loaded from xh_translations.js
                },
                fallbackLng: 'en',
                debug: true
            }, () => {
                updateContentAll();
            });

        // Initialize App
        function initializeApp() {
            console.log('Initializing app...');
            updateNavStickiness();
            populateAllSelects();
            setupEventListeners();
            renderOverviewSection();
            navigateToSection('overview');
            console.log('App initialized.');
        }

        // Update Navigation Stickiness
        function updateNavStickiness() {
            const header = document.querySelector('header');
            const nav = document.querySelector('nav');
            if (header && nav) {
                nav.style.top = `${header.offsetHeight}px`;
                document.querySelector('.content-area-wrapper').style.marginTop = `${header.offsetHeight + nav.offsetHeight}px`;
            } else {
                console.error('Header or nav not found.');
            }
        }

        // Populate Dropdowns
        function populateAllSelects() {
            const trackingMetricSelect = document.getElementById('trackingMetricSelect');
            const contributionFilterWeek = document.getElementById('contributionFilterWeek');
            const metrics = ['affection', 'support', 'food', 'safety', 'feedbackResponseTime'];
            if (trackingMetricSelect) {
                trackingMetricSelect.innerHTML = metrics.map(metric => `<option value="${metric}" data-i18n="metric${metric.charAt(0).toUpperCase() + metric.slice(1)}">${i18next.t(`metric${metric.charAt(0).toUpperCase() + metric.slice(1)}`)}</option>`).join('');
            }
            if (contributionFilterWeek) {
                contributionFilterWeek.innerHTML = relationshipData.weeks.map(week => `<option value="${week.weekNumber}">Week ${week.weekNumber} (${week.startDate})</option>`).join('');
            }
        }

        // Navigation
        function navigateToSection(sectionId) {
            console.log(`Navigating to section: ${sectionId}`);
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.replace('bg-pink-500', 'bg-gray-500'));
            const section = document.getElementById(sectionId);
            const tab = document.querySelector(`.nav-tab[data-section="${sectionId}"]`);
            if (section && tab) {
                section.classList.add('active');
                tab.classList.replace('bg-gray-500', 'bg-pink-500');
                if (sectionId !== 'overview') {
                    navigateToSubSection(sectionId, section.querySelector('.sub-nav-tab').dataset.subsection);
                }
                if (sectionId === 'overview') renderOverviewSection();
            } else {
                console.error(`Section or tab not found for ${sectionId}`);
            }
        }

        function navigateToSubSection(sectionId, subsectionId) {
            console.log(`Navigating to subsection: ${subsectionId}`);
            document.querySelectorAll(`#${sectionId} .sub-content`).forEach(content => content.classList.add('hidden'));
            document.querySelectorAll(`#${sectionId} .sub-nav-tab`).forEach(tab => tab.classList.replace('bg-pink-500', 'bg-gray-500'));
            const subsection = document.getElementById(subsectionId);
            const tab = document.querySelector(`#${sectionId} .sub-nav-tab[data-subsection="${subsectionId}"]`);
            if (subsection && tab) {
                subsection.classList.remove('hidden');
                tab.classList.replace('bg-gray-500', 'bg-pink-500');
                // Render subsection content
                if (sectionId === 'analysis' && subsectionId === 'tracking') updateTrackingChart();
                if (sectionId === 'analysis' && subsectionId === 'contributions') renderContributionsTable();
                if (sectionId === 'analysis' && subsectionId === 'reinforcement') renderReinforcementTable();
                if (sectionId === 'media' && subsectionId === 'songs') renderSongsList();
                if (sectionId === 'media' && subsectionId === 'photos') renderPhotoGallery();
                if (sectionId === 'media' && subsectionId === 'visited') renderTravelSection('visited');
                if (sectionId === 'media' && subsectionId === 'dream') renderTravelSection('dream');
                if (sectionId === 'connect' && subsectionId === 'feedback') renderFeedbackLog();
                if (sectionId === 'connect' && subsectionId === 'logs') renderActionLog();
            } else {
                console.error(`Subsection or tab not found for ${subsectionId}`);
            }
        }

        // Rendering Functions
        function renderOverviewSection() {
            console.log('Rendering overview section...');
            // Update Dashboard Metrics
            ['affection', 'support', 'food', 'safety'].forEach(metric => {
                const element = document.getElementById(`metric${metric.charAt(0).toUpperCase() + metric.slice(1)}`);
                if (element) {
                    element.textContent = calculateAverageMetric(metric);
                }
            });
            renderOverviewTimelineCarousel();
            renderOverviewImageCarousel();
            updateDashboardChart();
        }

        function calculateAverageMetric(metric) {
            const scores = relationshipData.weeks.flatMap(week => [
                week.contributions[metric]?.salatiso?.score || 0,
                week.contributions[metric]?.tee?.score || 0
            ]).filter(score => score > 0);
            return scores.length ? (scores.reduce((sum, score) => sum + score, 0) / scores.length).toFixed(1) : 'N/A';
        }

        function renderOverviewTimelineCarousel() {
            const carousel = document.getElementById('timelineCarousel');
            if (carousel) {
                carousel.innerHTML = relationshipData.weeks.map(week => `
                    <div class="carousel-item bg-pink-100 p-4 rounded w-64">
                        <h4>Week ${week.weekNumber} (${week.startDate})</h4>
                        <p data-i18n="${week.summaryKey}">${i18next.t(week.summaryKey)}</p>
                        <button class="details-button bg-pink-500 text-white px-2 py-1 rounded" data-week="${week.weekNumber}" data-i18n="seeDetails">See Details</button>
                    </div>
                `).join('');
            }
        }

        function renderOverviewImageCarousel() {
            const carousel = document.getElementById('imageCarousel');
            if (carousel) {
                const shuffledPhotos = relationshipData.photoFileNames.sort(() => Math.random() - 0.5);
                carousel.innerHTML = shuffledPhotos.map(photo => `
                    <div class="carousel-item">
                        <img src="assets/photos/${photo}" alt="Memory" class="w-64 h-48 object-cover rounded">
                    </div>
                `).join('');
                // Auto-play carousel
                setInterval(() => {
                    if (carousel.scrollLeft + carousel.clientWidth < carousel.scrollWidth) {
                        carousel.scrollBy({ left: 256, behavior: 'smooth' });
                    } else {
                        carousel.scrollTo({ left: 0, behavior: 'smooth' });
                    }
                }, 5000);
            }
        }

        function updateDashboardChart() {
            const ctx = document.getElementById('dashboardChart')?.getContext('2d');
            const metric = document.getElementById('dashboardMetricSelect')?.value || 'affection';
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: relationshipData.weeks.map(week => `Week ${week.weekNumber}`),
                        datasets: [
                            {
                                label: i18next.t(`metric${metric.charAt(0).toUpperCase() + metric.slice(1)}`),
                                data: relationshipData.weeks.map(week => week.contributions[metric]?.salatiso?.score || 0),
                                borderColor: '#ff69b4',
                                fill: false
                            },
                            {
                                label: i18next.t(`metric${metric.charAt(0).toUpperCase() + metric.slice(1)}`),
                                data: relationshipData.weeks.map(week => week.contributions[metric]?.tee?.score || 0),
                                borderColor: '#ff1493',
                                fill: false
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        function updateTrackingChart() {
            const ctx = document.getElementById('trackingChart')?.getContext('2d');
            const metric = document.getElementById('trackingMetricSelect')?.value || 'affection';
            if (ctx) {
                new Chart(ctx, {
                    type: metric === 'feedbackResponseTime' ? 'bar' : 'line',
                    data: {
                        labels: relationshipData.weeks.map(week => `Week ${week.weekNumber}`),
                        datasets: [
                            {
                                label: i18next.t(`metric${metric.charAt(0).toUpperCase() + metric.slice(1)}`),
                                data: relationshipData.weeks.map(week => week.contributions[metric]?.salatiso?.score || 0),
                                borderColor: '#ff69b4',
                                backgroundColor: '#ff69b4',
                                fill: metric === 'feedbackResponseTime'
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        function renderContributionsTable() {
            const tableBody = document.getElementById('contributionsTableBody');
            const weekNumber = document.getElementById('contributionFilterWeek')?.value || 1;
            const week = relationshipData.weeks.find(w => w.weekNumber == weekNumber);
            if (tableBody && week) {
                tableBody.innerHTML = Object.keys(week.contributions).map(param => `
                    <tr>
                        <td>${i18next.t(`metric${param.charAt(0).toUpperCase() + param.slice(1)}`)}</td>
                        <td>${week.contributions[param].salatiso.score || 'N/A'} (${week.contributions[param].salatiso.actions.join(', ')})</td>
                        <td>${week.contributions[param].tee.score || 'N/A'} (${week.contributions[param].tee.actions.join(', ')})</td>
                        <td>${week.contributions[param].salatiso.notes || week.contributions[param].tee.notes || ''}</td>
                    </tr>
                `).join('');
            }
        }

        function renderReinforcementTable() {
            const tableBody = document.getElementById('reinforcementTableBody');
            if (tableBody) {
                tableBody.innerHTML = relationshipData.reinforcementWords.map(word => `
                    <tr>
                        <td>${word.word}</td>
                        <td>${word.purpose}</td>
                        <td>${word.occurrences.salatiso.join(', ') || 'None'}</td>
                        <td>${word.occurrences.tee.join(', ') || 'None'}</td>
                        <td>${word.occurrences.joint.join(', ') || 'None'}</td>
                    </tr>
                `).join('');
            }
        }

        function renderSongsList() {
            const songsList = document.getElementById('songsList');
            if (songsList) {
                const songs = relationshipData.weeks.flatMap(week => week.events.filter(event => event.type === 'music'));
                songsList.innerHTML = songs.map(song => `
                    <div class="carousel-item bg-pink-100 p-4 rounded w-64">
                        <p>${song.songTitle}</p>
                        <p>${i18next.t('sharedBy')} ${song.sharedBy}</p>
                        <a href="${song.songUrl}" target="_blank" class="text-pink-500" data-i18n="listen">Listen</a>
                    </div>
                `).join('');
            }
        }

        function renderPhotoGallery() {
            const photos = document.getElementById('photos');
            if (photos) {
                photos.innerHTML = relationshipData.photoFileNames.map(photo => `
                    <div class="carousel-item">
                        <img src="assets/photos/${photo}" alt="Memory" class="w-32 h-32 object-cover rounded">
                    </div>
                `).join('');
            }
        }

        function renderTravelSection(type) {
            const list = document.getElementById(`${type}List`);
            if (list) {
                const trips = relationshipData.travelLog.filter(trip => trip.type === type);
                list.innerHTML = trips.map(trip => `
                    <div class="carousel-item bg-pink-100 p-4 rounded w-64">
                        <h4>${trip.destination}</h4>
                        <p>${trip.dates || trip.notes}</p>
                        ${trip.photos ? trip.photos.map(photo => `<img src="assets/photos/${photo}" alt="${trip.destination}" class="w-32 h-32 object-cover rounded">`).join('') : ''}
                    </div>
                `).join('');
            }
        }

        function renderFeedbackLog() {
            const feedbackLog = document.getElementById('feedbackLog');
            if (feedbackLog) {
                feedbackLog.innerHTML = relationshipData.feedbackLog.map(fb => `
                    <div class="bg-pink-100 p-4 rounded mb-2">
                        <p><strong>${i18next.t('from')}</strong> ${fb.sender} <strong>${i18next.t('to')}</strong> ${fb.recipient}</p>
                        <p>${fb.message}</p>
                        <p>${fb.timestamp}</p>
                        <p>${fb.responseStatus || 'Pending'}</p>
                    </div>
                `).join('');
            }
        }

        function renderActionLog() {
            const actionLog = document.getElementById('actionLog');
            if (actionLog) {
                actionLog.innerHTML = relationshipData.actionLog.map(action => `
                    <div class="bg-pink-100 p-4 rounded mb-2">
                        <p><strong>${action.type}</strong> by ${action.sender}</p>
                        <p>${action.message}</p>
                        <p>${action.timestamp}</p>
                    </div>
                `).join('');
            }
        }

        function showModal(modalId, content = '') {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (modalId === 'alertModal') {
                    document.getElementById('alertMessage').textContent = content;
                } else if (modalId === 'playlistModal') {
                    document.getElementById('playlistFrame').src = relationshipData.playlistUrl;
                }
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                if (modalId === 'playlistModal') {
                    document.getElementById('playlistFrame').src = '';
                }
            }
        }

        function renderModalCarousel(weekNumber) {
            const modalCarousel = document.getElementById('modalCarousel');
            const week = relationshipData.weeks.find(w => w.weekNumber == weekNumber);
            if (modalCarousel && week) {
                modalCarousel.innerHTML = week.events.map(event => `
                    <div class="carousel-item p-4">
                        <p><strong>${event.type.charAt(0).toUpperCase() + event.type.slice(1)}</strong>: ${event.songTitle || event.textKey}</p>
                        ${event.songUrl ? `<a href="${event.songUrl}" target="_blank" class="text-pink-500">${i18next.t('listen')}</a>` : ''}
                        <p>${event.originalMessage}</p>
                    </div>
                `).join('');
                showModal('detailsModal');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => navigateToSection(tab.dataset.section));
            });
            document.querySelectorAll('.sub-nav-tab').forEach(tab => {
                tab.addEventListener('click', () => navigateToSubSection(tab.closest('.content-section').id, tab.dataset.subsection));
            });
            // Language Switch
            document.getElementById('langEN')?.addEventListener('click', () => {
                i18next.changeLanguage('en', updateContentAll);
            });
            document.getElementById('langXH')?.addEventListener('click', () => {
                i18next.changeLanguage('xh', updateContentAll);
            });
            // Modals
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.closest('.modal').id));
            });
            document.getElementById('alertOK')?.addEventListener('click', () => closeModal('alertModal'));
            document.getElementById('playlistButton')?.addEventListener('click', () => showModal('playlistModal'));
            // Timeline Details
            document.getElementById('timelineCarousel')?.addEventListener('click', e => {
                if (e.target.classList.contains('details-button')) {
                    renderModalCarousel(e.target.dataset.week);
                }
            });
            // Forms
            document.getElementById('feedbackForm')?.addEventListener('submit', e => {
                e.preventDefault();
                const sender = document.getElementById('feedbackSender').value;
                const recipient = document.getElementById('feedbackRecipient').value;
                const message = document.getElementById('feedbackMessage').value;
                relationshipData.feedbackLog.push({
                    sender,
                    recipient,
                    message,
                    timestamp: new Date().toISOString(),
                    responseStatus: 'Pending'
                });
                renderFeedbackLog();
                showModal('alertModal', i18next.t('feedbackSent'));
                e.target.reset();
            });
            document.getElementById('apologyForm')?.addEventListener('submit', e => {
                e.preventDefault();
                const sender = document.getElementById('apologySender').value;
                const message = document.getElementById('apologyMessage').value;
                relationshipData.actionLog.push({
                    type: 'Apology',
                    sender,
                    message,
                    timestamp: new Date().toISOString()
                });
                renderActionLog();
                showModal('alertModal', i18next.t('apologySent'));
                e.target.reset();
            });
            // Chart Updates
            document.getElementById('dashboardMetricSelect')?.addEventListener('change', updateDashboardChart);
            document.getElementById('trackingMetricSelect')?.addEventListener('change', updateTrackingChart);
            document.getElementById('contributionFilterWeek')?.addEventListener('change', renderContributionsTable);
            // Compatibility
            document.getElementById('checkCompatibility')?.addEventListener('click', () => {
                const salatisoDate = document.getElementById('salatisoBirthday').value;
                const teeDate = document.getElementById('teeBirthday').value;
                if (salatisoDate && teeDate) {
                    const result = calculateZodiacCompatibility(salatisoDate, teeDate);
                    document.getElementById('compatibilityResult').textContent = result;
                }
            });
            // Report Placeholder
            document.getElementById('generateReport')?.addEventListener('click', () => {
                showModal('alertModal', i18next.t('comingSoon'));
            });
        }

        // Zodiac Compatibility (Simplified)
        function calculateZodiacCompatibility(date1, date2) {
            // Simplified logic for demo
            return i18next.t('compatibilityResult', { sign1: 'Zodiac1', sign2: 'Zodiac2' });
        }

        // Update Translations
        function updateContentAll() {
            document.querySelectorAll('[data-i18n]').forEach(elem => {
                const key = elem.dataset.i18n;
                if (key.startsWith('[placeholder]')) {
                    elem.placeholder = i18next.t(key.replace('[placeholder]', ''));
                } else {
                    elem.textContent = i18next.t(key);
                }
            });
            renderOverviewSection();
            renderContributionsTable();
            renderReinforcementTable();
            renderSongsList();
            renderPhotoGallery();
            renderTravelSection('visited');
            renderTravelSection('dream');
            renderFeedbackLog();
            renderActionLog();
        }

        // Start App
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
