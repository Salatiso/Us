<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tee & Me - Our Story</title>
    <!-- Visualization & Content Choices:
        - Report Info: Weekly relationship summaries, key events, shared media. Goal: Quick overview of relationship progression. Viz/Presentation: Horizontal carousel of cards (Quick Timeline) in Overview. Interaction: Click "See Details" to open a modal with more info, including an internal carousel for multiple events per week. Justification: Carousels are ideal for sequential, condensed information in a fixed-height section. Modals allow for detailed views without leaving the main context. Library/Method: HTML/Tailwind for carousel structure, JS for population and modal control.
        - Report Info: Metrics like Affection, Support, Food Prep, Safety scores over time. Goal: Visualize trends and current status. Viz/Presentation: Dashboard cards (Overview) for latest/average scores; Line chart (Overview) for initial weeks; Line/Bar chart (Analysis Hub - Tracking) for selected metric over all weeks. Interaction: Dropdown to select metric for charts. Justification: Cards provide quick snapshots. Line/Bar charts are effective for trend visualization. Library/Method: Chart.js (Canvas) for charts, JS for dynamic updates.
        - Report Info: Individual contributions by Salatiso & Tee (affection, support, finances, chores, etc.). Goal: Compare and reflect on shared responsibilities. Viz/Presentation: Table (Analysis Hub - Contributions), filterable by week. Interaction: Dropdown to select week. Table content scrolls internally. Justification: Tables are suitable for detailed, structured data comparison. Internal scroll manages overflow. Library/Method: HTML/Tailwind for table, JS for filtering and population.
        - Report Info: Reinforcement words/actions, purpose, occurrences. Goal: Analyze positive communication patterns. Viz/Presentation: Table (Analysis Hub - Reinforcement). Table scrolls internally. Justification: Structured display for specific communication data. Library/Method: HTML/Tailwind for table, JS for population.
        - Report Info: Shared songs, photo moments, travel logs (visited/dream). Goal: Curate and revisit shared memories. Viz/Presentation: Scrollable list for songs (Media Hub); Scrollable grid for photos (Media Hub); Cards for travel entries (Media Hub). Interaction: Links for songs, internal scroll for lists/grids. Justification: Visually engaging ways to present media and categorized experiences. Library/Method: HTML/Tailwind, JS for population.
        - Report Info: Feedback exchange, relationship actions (apology, dissatisfaction, date booking, termination). Goal: Facilitate communication and track significant interactions. Viz/Presentation: Forms and logs (Connect & Resolve Hub). Interaction: Form submission, log display with internal scroll. Justification: Structured tools for active relationship management. Library/Method: HTML/Tailwind for forms/logs, JS for handling.
        - Report Info: Compatibility (Astrology, placeholders for other tests). Goal: Fun and reflective engagement. Viz/Presentation: Input fields and display areas for Astrology; Placeholders for other tests (LifeSync & Fun Hub). Interaction: Input birthdays for Astrology. Justification: Lighthearted and future-looking interactive elements. Library/Method: HTML/Tailwind, JS for Astrology logic.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. All charts are Chart.js (Canvas). Icons are Font Awesome. Other visuals are HTML/Tailwind.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body, html {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden; /* No scroll on body */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fdf2f8; /* rose-50 */
        }
        #videoBackground {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            object-fit: cover;
        }
        .content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(253, 242, 248, 0.85); /* rose-50 with opacity */
            z-index: -50;
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background-color: rgba(236, 72, 153, 0.8); /* pink-500 with opacity */
            backdrop-filter: blur(5px);
        }
        nav.main-nav {
            position: fixed;
            left: 0;
            width: 100%;
            z-index: 999;
            background-color: rgba(219, 39, 119, 0.85); /* pink-600 with opacity */
            backdrop-filter: blur(5px);
        }
        .content-area-wrapper {
            width: 100%;
            overflow: hidden; /* Crucial for no-scroll sections */
            display: flex;
            flex-direction: column;
        }
        .content-area {
            flex-grow: 1;
            overflow: hidden; /* Each section manages its own potential scroll */
            display: flex; /* To make sections take full height */
        }
        .content-section {
            width: 100%;
            height: 100%; /* Fill .content-area */
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden; /* No scroll on the section itself */
            padding: 1rem; /* Inner padding for content */
            background-color: transparent; /* Content sections are transparent over the overlay/video */
        }
        .content-section.active {
            display: flex;
        }
        .sub-nav-tabs {
            border-bottom: 2px solid #f472b6; /* pink-400 */
            margin-bottom: 1rem;
        }
        .sub-nav-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px; /* Align with parent border */
            color: #881337; /* rose-800 */
        }
        .sub-nav-tab.active, .sub-nav-tab:hover {
            border-color: #db2777; /* pink-600 */
            color: #db2777; /* pink-600 */
            font-weight: 600;
        }
        .sub-content {
            display: none;
            flex-grow: 1;
            overflow-y: auto; /* Allows internal scrolling for sub-content */
            padding: 0.5rem;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .sub-content::-webkit-scrollbar { /* Chrome, Safari, Opera */
            display: none;
        }
        .sub-content.active {
            display: block;
        }

        /* Carousel Styles */
        .carousel {
            position: relative;
            overflow: hidden;
        }
        .carousel-inner {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-item {
            min-width: 100%; /* Full width for main item, adjust for multi-item view */
            box-sizing: border-box;
        }
        .carousel-control-prev, .carousel-control-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.5);
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
        }
        .carousel-control-prev { left: 10px; }
        .carousel-control-next { right: 10px; }

        /* Quick Timeline Carousel Specifics */
        #quickTimelineCarousel .carousel-inner {
            /* display: flex; already set */
        }
        #quickTimelineCarousel .carousel-item {
            min-width: 280px; /* Adjust for card size */
            max-width: 280px;
            padding: 0 0.5rem; /* Spacing between cards */
        }
         /* Photo Gallery Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
        }
        .photo-grid img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* flex when active */
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af; /* gray-400 */
        }
        .modal-close:hover {
            color: #374151; /* gray-700 */
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Example max-width */
            margin-left: auto;
            margin-right: auto;
            height: 250px; /* Base height, adjust with Tailwind or media queries */
            max-height: 300px; /* Max height */
        }
        @media (min-width: 768px) { /* md */
            .chart-container {
                height: 300px;
                max-height: 350px;
            }
        }
        
        /* Floating action button */
        #playlistFab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1050;
        }

        /* Custom scrollbar for sub-content (if not hidden) */
        .sub-content::-webkit-scrollbar {
            width: 8px;
        }
        .sub-content::-webkit-scrollbar-track {
            background: #fce7f3; /* rose-100 */
        }
        .sub-content::-webkit-scrollbar-thumb {
            background: #f472b6; /* pink-400 */
            border-radius: 4px;
        }
        .sub-content::-webkit-scrollbar-thumb:hover {
            background: #ec4899; /* pink-500 */
        }
        .table-scroll-container {
            max-height: calc(100% - 4rem); /* Adjust based on surrounding elements */
            overflow-y: auto;
        }

    </style>
</head>
<body>
    <video autoplay muted loop id="videoBackground">
        <source src="assets/videos/background.mp4" type="video/mp4">
        Your browser does not support HTML5 video.
    </video>
    <div class="content-overlay"></div>

    <header class="p-3 text-white flex justify-between items-center">
        <h1 class="text-xl font-bold" data-i18n="siteTitle">Tee & Me - Our Story</h1>
        <div>
            <button id="lang-en" class="lang-switcher px-2 py-1 text-sm rounded bg-white/30 hover:bg-white/50" data-lang="en">EN</button>
            <button id="lang-xh" class="lang-switcher px-2 py-1 text-sm rounded bg-white/30 hover:bg-white/50" data-lang="xh">XH</button>
        </div>
    </header>

    <nav class="main-nav p-2 shadow-md">
        <div class="container mx-auto flex justify-around items-center text-sm">
            <button class="nav-link py-1 px-2 rounded hover:bg-white/20 text-white" data-section="overview" data-i18n="nav.overview">Overview</button>
            <button class="nav-link py-1 px-2 rounded hover:bg-white/20 text-white" data-section="analysis" data-i18n="nav.analysisHub">Analysis Hub</button>
            <button class="nav-link py-1 px-2 rounded hover:bg-white/20 text-white" data-section="media" data-i18n="nav.mediaTravelHub">Media & Travel</button>
            <button class="nav-link py-1 px-2 rounded hover:bg-white/20 text-white" data-section="connect" data-i18n="nav.connectResolve">Connect & Resolve</button>
            <button class="nav-link py-1 px-2 rounded hover:bg-white/20 text-white" data-section="lifesync" data-i18n="nav.lifeSyncFun">LifeSync & Fun</button>
        </div>
    </nav>

    <div class="content-area-wrapper">
        <div class="content-area">
            <section id="overview" class="content-section active">
                <h2 class="text-2xl font-semibold mb-4 text-pink-700" data-i18n="overview.title">Our Journey Snapshot</h2>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-hidden">
                    <div class="flex flex-col gap-4 overflow-y-auto p-1">
                        <div>
                            <h3 class="text-lg font-medium text-pink-600" data-i18n="overview.dashboard">Dashboard</h3>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div class="bg-rose-100 p-3 rounded-lg shadow">
                                    <p class="text-sm text-rose-700" data-i18n="overview.affectionLevel">Affection Level</p>
                                    <p id="metricAffection" class="text-xl font-bold text-rose-800">8.5/10</p>
                                </div>
                                <div class="bg-rose-100 p-3 rounded-lg shadow">
                                    <p class="text-sm text-rose-700" data-i18n="overview.supportScore">Support Score</p>
                                    <p id="metricSupport" class="text-xl font-bold text-rose-800">9.2/10</p>
                                </div>
                                <div class="bg-rose-100 p-3 rounded-lg shadow">
                                    <p class="text-sm text-rose-700" data-i18n="overview.foodPrep">Food Prep</p>
                                    <p id="metricFood" class="text-xl font-bold text-rose-800">Balanced</p>
                                </div>
                                <div class="bg-rose-100 p-3 rounded-lg shadow">
                                    <p class="text-sm text-rose-700" data-i18n="overview.safetySecurity">Safety/Security</p>
                                    <p id="metricSafety" class="text-xl font-bold text-rose-800">Strong</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-pink-600" data-i18n="overview.specialSong">Our Special Song</h3>
                            <p class="mt-1 text-sm text-gray-700">"Thank You Baby! (For Makin' Someday Come So Soon)"</p>
                            <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" class="text-pink-500 hover:text-pink-700 text-sm" data-i18n="overview.listen">Listen <i class="fas fa-play-circle"></i></a>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-pink-600" data-i18n="overview.quickTimeline">Quick Timeline</h3>
                            <div id="quickTimelineCarousel" class="carousel mt-2 bg-white/50 p-2 rounded-lg">
                                <div class="carousel-inner">
                                    </div>
                                <button class="carousel-control-prev"><i class="fas fa-chevron-left"></i></button>
                                <button class="carousel-control-next"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 overflow-y-auto p-1">
                        <div>
                            <h3 class="text-lg font-medium text-pink-600" data-i18n="overview.imageCarousel">Shared Moments</h3>
                            <div id="overviewImageCarousel" class="carousel mt-2 h-64 md:h-80 rounded-lg shadow-lg">
                                <div class="carousel-inner h-full">
                                    </div>
                                <button class="carousel-control-prev"><i class="fas fa-chevron-left"></i></button>
                                <button class="carousel-control-next"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-pink-600" data-i18n="overview.dashboardChartTitle">Initial Weeks Metric Trend</h3>
                            <div class="chart-container mt-2 bg-white/50 p-2 rounded-lg">
                                <canvas id="dashboardChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="analysis" class="content-section">
                <h2 class="text-2xl font-semibold text-pink-700" data-i18n="analysisHub.title">Analysis Hub</h2>
                <div class="sub-nav-tabs flex">
                    <button class="sub-nav-tab active" data-subtarget="tracking" data-i18n="analysisHub.tracking.title">Tracking</button>
                    <button class="sub-nav-tab" data-subtarget="contributions" data-i18n="analysisHub.contributions.title">Contributions</button>
                    <button class="sub-nav-tab" data-subtarget="reinforcement" data-i18n="analysisHub.reinforcement.title">Reinforcement</button>
                </div>
                <div id="tracking" class="sub-content active">
                    <label for="trackingMetricSelect" class="block text-sm font-medium text-gray-700" data-i18n="analysisHub.tracking.selectMetric">Select Metric:</label>
                    <select id="trackingMetricSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md">
                        </select>
                    <div class="chart-container mt-4 h-[calc(100%-6rem)] max-h-[calc(100%-6rem)] bg-white/50 p-2 rounded-lg">
                         <canvas id="trackingChart"></canvas>
                    </div>
                </div>
                <div id="contributions" class="sub-content">
                    <label for="contributionFilterWeek" class="block text-sm font-medium text-gray-700" data-i18n="analysisHub.contributions.filterByWeek">Filter by Week:</label>
                    <select id="contributionFilterWeek" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md">
                        </select>
                    <div class="mt-4 table-scroll-container bg-white/50 p-2 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-rose-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.contributions.parameter">Parameter</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.contributions.salatiso">Salatiso</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.contributions.tee">Tee</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.contributions.notes">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="contributionsTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div id="reinforcement" class="sub-content">
                     <div class="mt-4 table-scroll-container bg-white/50 p-2 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-rose-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.reinforcement.wordAction">Word/Action</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.reinforcement.purpose">Purpose</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.reinforcement.occurrencesSalatiso">Salatiso (Weeks)</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.reinforcement.occurrencesTee">Tee (Weeks)</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-rose-600 uppercase tracking-wider" data-i18n="analysisHub.reinforcement.occurrencesJoint">Joint (Weeks)</th>
                                </tr>
                            </thead>
                            <tbody id="reinforcementTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="media" class="content-section">
                <h2 class="text-2xl font-semibold text-pink-700" data-i18n="mediaTravelHub.title">Media & Travel Hub</h2>
                <div class="sub-nav-tabs flex">
                    <button class="sub-nav-tab active" data-subtarget="songs" data-i18n="mediaTravelHub.sharedSongs.title">Shared Songs</button>
                    <button class="sub-nav-tab" data-subtarget="photos" data-i18n="mediaTravelHub.photoMoments.title">Photo Moments</button>
                    <button class="sub-nav-tab" data-subtarget="visited" data-i18n="mediaTravelHub.visited.title">Visited</button>
                    <button class="sub-nav-tab" data-subtarget="dream" data-i18n="mediaTravelHub.dreamTrips.title">Dream Trips</button>
                </div>
                <div id="songs" class="sub-content active">
                    <ul id="sharedSongsList" class="space-y-2">
                        </ul>
                </div>
                <div id="photos" class="sub-content">
                    <div id="photoMomentsGrid" class="photo-grid">
                        </div>
                </div>
                <div id="visited" class="sub-content">
                    <div id="visitedTripsList" class="space-y-3">
                        </div>
                </div>
                <div id="dream" class="sub-content">
                    <div id="dreamTripsList" class="space-y-3">
                        </div>
                </div>
            </section>

            <section id="connect" class="content-section">
                <h2 class="text-2xl font-semibold text-pink-700" data-i18n="connectResolve.title">Connect & Resolve</h2>
                <div class="sub-nav-tabs flex">
                    <button class="sub-nav-tab active" data-subtarget="feedback" data-i18n="connectResolve.feedback.title">Feedback</button>
                    <button class="sub-nav-tab" data-subtarget="actions" data-i18n="connectResolve.actions.title">Actions</button>
                    <button class="sub-nav-tab" data-subtarget="logs" data-i18n="connectResolve.logs.title">Logs</button>
                </div>
                <div id="feedback" class="sub-content active grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-medium text-pink-600" data-i18n="connectResolve.feedback.give">Give Feedback</h3>
                        <form id="feedbackForm" class="space-y-3 mt-2">
                            <div>
                                <label for="feedbackSender" class="block text-sm font-medium text-gray-700" data-i18n="connectResolve.feedback.sender">Sender</label>
                                <select id="feedbackSender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-300 focus:ring focus:ring-pink-200 focus:ring-opacity-50">
                                    <option value="Salatiso">Salatiso</option>
                                    <option value="Tee">Tee</option>
                                </select>
                            </div>
                            <div>
                                <label for="feedbackRecipient" class="block text-sm font-medium text-gray-700" data-i18n="connectResolve.feedback.recipient">Recipient</label>
                                <select id="feedbackRecipient" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-300 focus:ring focus:ring-pink-200 focus:ring-opacity-50">
                                    <option value="Tee">Tee</option>
                                    <option value="Salatiso">Salatiso</option>
                                </select>
                            </div>
                            <div>
                                <label for="feedbackMessage" class="block text-sm font-medium text-gray-700" data-i18n="connectResolve.feedback.message">Message</label>
                                <textarea id="feedbackMessage" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-300 focus:ring focus:ring-pink-200 focus:ring-opacity-50" required></textarea>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-600" data-i18n="connectResolve.feedback.send">Send Feedback</button>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-pink-600" data-i18n="connectResolve.feedback.logTitle">Feedback Log</h3>
                        <div id="feedbackLogContainer" class="mt-2 space-y-2 max-h-[calc(100%-3rem)] overflow-y-auto">
                            </div>
                    </div>
                </div>
                <div id="actions" class="sub-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <form id="apologyForm" class="space-y-3 p-3 bg-rose-50 rounded-lg shadow">
                            <h4 class="font-semibold text-rose-700" data-i18n="connectResolve.actions.apology.title">Make an Apology</h4>
                            <select id="apologyActor" class="w-full rounded-md border-gray-300"><option value="Salatiso">Salatiso</option><option value="Tee">Tee</option></select>
                            <textarea id="apologyMessage" placeholder="Apology message..." rows="2" class="w-full rounded-md border-gray-300" required></textarea>
                            <button type="submit" class="px-3 py-1 bg-rose-500 text-white rounded hover:bg-rose-600" data-i18n="connectResolve.actions.apology.submit">Submit Apology</button>
                        </form>
                        <form id="dissatisfactionForm" class="space-y-3 p-3 bg-rose-50 rounded-lg shadow">
                            <h4 class="font-semibold text-rose-700" data-i18n="connectResolve.actions.dissatisfaction.title">Express Dissatisfaction</h4>
                            <select id="dissatisfactionActor" class="w-full rounded-md border-gray-300"><option value="Salatiso">Salatiso</option><option value="Tee">Tee</option></select>
                            <textarea id="dissatisfactionMessage" placeholder="Details of dissatisfaction..." rows="2" class="w-full rounded-md border-gray-300" required></textarea>
                            <button type="submit" class="px-3 py-1 bg-rose-500 text-white rounded hover:bg-rose-600" data-i18n="connectResolve.actions.dissatisfaction.submit">Submit Concern</button>
                        </form>
                        <form id="bookDateForm" class="space-y-3 p-3 bg-rose-50 rounded-lg shadow">
                            <h4 class="font-semibold text-rose-700" data-i18n="connectResolve.actions.bookDate.title">Book a Date</h4>
                            <select id="bookDateActor" class="w-full rounded-md border-gray-300"><option value="Salatiso">Salatiso</option><option value="Tee">Tee</option></select>
                            <input type="text" id="bookDateActivity" placeholder="Activity description" class="w-full rounded-md border-gray-300" required>
                            <input type="date" id="bookDateDate" class="w-full rounded-md border-gray-300" required>
                            <button type="submit" class="px-3 py-1 bg-rose-500 text-white rounded hover:bg-rose-600" data-i18n="connectResolve.actions.bookDate.submit">Propose Date</button>
                        </form>
                        <form id="terminationForm" class="space-y-3 p-3 bg-red-50 rounded-lg shadow">
                            <h4 class="font-semibold text-red-700" data-i18n="connectResolve.actions.termination.title">Initiate Relationship Termination</h4>
                            <select id="terminationActor" class="w-full rounded-md border-gray-300"><option value="Salatiso">Salatiso</option><option value="Tee">Tee</option></select>
                            <select id="terminationReason" class="w-full rounded-md border-gray-300">
                                <option value="irreconcilable_differences" data-i18n="connectResolve.actions.termination.reasonIrreconcilable">Irreconcilable Differences</option>
                                <option value="growing_apart" data-i18n="connectResolve.actions.termination.reasonGrowingApart">Growing Apart</option>
                                <option value="other" data-i18n="connectResolve.actions.termination.reasonOther">Other (Specify)</option>
                            </select>
                            <textarea id="terminationNotes" placeholder="Additional notes (if any)..." rows="2" class="w-full rounded-md border-gray-300"></textarea>
                            <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600" data-i18n="connectResolve.actions.termination.submit">Initiate</button>
                        </form>
                    </div>
                </div>
                <div id="logs" class="sub-content">
                    <h3 class="text-lg font-medium text-pink-600" data-i18n="connectResolve.logs.actionLogTitle">Action Log</h3>
                    <div id="actionLogContainer" class="mt-2 space-y-2 max-h-[calc(100%-3rem)] overflow-y-auto">
                        </div>
                </div>
            </section>

            <section id="lifesync" class="content-section">
                <h2 class="text-2xl font-semibold text-pink-700" data-i18n="lifeSyncFun.title">LifeSync & Fun</h2>
                <div class="sub-nav-tabs flex">
                    <button class="sub-nav-tab active" data-subtarget="compatibility" data-i18n="lifeSyncFun.compatibility.title">Compatibility</button>
                    <button class="sub-nav-tab" data-subtarget="quizzes" data-i18n="lifeSyncFun.quizzes.title">Quizzes</button>
                    <button class="sub-nav-tab" data-subtarget="reports" data-i18n="lifeSyncFun.reports.title">LifeSync Reports</button>
                </div>
                <div id="compatibility" class="sub-content active space-y-4">
                    <div class="p-3 bg-rose-50 rounded-lg shadow">
                        <h3 class="text-md font-semibold text-rose-700" data-i18n="lifeSyncFun.compatibility.astrology.title">Astrology Compatibility</h3>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <label for="salatisoBirthday" class="text-sm" data-i18n="lifeSyncFun.compatibility.astrology.salatisoBday">Salatiso's Birthday:</label>
                                <input type="date" id="salatisoBirthday" class="w-full rounded-md border-gray-300 text-sm p-1">
                            </div>
                            <div>
                                <label for="teeBirthday" class="text-sm" data-i18n="lifeSyncFun.compatibility.astrology.teeBday">Tee's Birthday:</label>
                                <input type="date" id="teeBirthday" class="w-full rounded-md border-gray-300 text-sm p-1">
                            </div>
                        </div>
                        <button id="checkAstrology" class="mt-2 px-3 py-1 bg-rose-500 text-white text-sm rounded hover:bg-rose-600" data-i18n="lifeSyncFun.compatibility.astrology.check">Check Compatibility</button>
                        <div id="astrologyResult" class="mt-2 text-sm"></div>
                    </div>
                    <div class="p-3 bg-rose-50 rounded-lg shadow">
                        <h3 class="text-md font-semibold text-rose-700" data-i18n="lifeSyncFun.compatibility.values.title">Values Alignment</h3>
                        <p class="text-xs text-gray-600" data-i18n="lifeSyncFun.compatibility.values.desc">Discover how your core values align.</p>
                        <button class="placeholder-test-btn mt-1 px-3 py-1 bg-gray-400 text-white text-sm rounded" data-i18n="lifeSyncFun.compatibility.startTest">Start Test</button>
                    </div>
                     <div class="p-3 bg-rose-50 rounded-lg shadow">
                        <h3 class="text-md font-semibold text-rose-700" data-i18n="lifeSyncFun.compatibility.communication.title">Communication Styles</h3>
                        <p class="text-xs text-gray-600" data-i18n="lifeSyncFun.compatibility.communication.desc">Understand your communication patterns.</p>
                        <button class="placeholder-test-btn mt-1 px-3 py-1 bg-gray-400 text-white text-sm rounded" data-i18n="lifeSyncFun.compatibility.startTest">Start Test</button>
                    </div>
                    <div class="p-3 bg-rose-50 rounded-lg shadow">
                        <h3 class="text-md font-semibold text-rose-700" data-i18n="lifeSyncFun.compatibility.proverbs.title">African Proverbs Wisdom Match</h3>
                        <p class="text-xs text-gray-600" data-i18n="lifeSyncFun.compatibility.proverbs.desc">Find wisdom in shared cultural understanding.</p>
                        <button class="placeholder-test-btn mt-1 px-3 py-1 bg-gray-400 text-white text-sm rounded" data-i18n="lifeSyncFun.compatibility.startTest">Start Test</button>
                    </div>
                </div>
                <div id="quizzes" class="sub-content">
                    <p data-i18n="lifeSyncFun.quizzes.comingSoon">Relationship quizzes coming soon!</p>
                </div>
                <div id="reports" class="sub-content">
                    <label for="reportPeriod" class="block text-sm font-medium" data-i18n="lifeSyncFun.reports.selectPeriod">Select Period:</label>
                    <select id="reportPeriod" class="mt-1 block w-full rounded-md border-gray-300">
                        <option value="last_3_months" data-i18n="lifeSyncFun.reports.periodLast3Months">Last 3 Months</option>
                        <option value="all_time" data-i18n="lifeSyncFun.reports.periodAllTime">All Time</option>
                    </select>
                    <button id="generateReportBtn" class="mt-2 px-4 py-2 bg-pink-500 text-white rounded hover:bg-pink-600" data-i18n="lifeSyncFun.reports.generate">Generate Report</button>
                </div>
            </section>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 w-full bg-gray-800 text-white text-center text-xs p-1 z-1000">
        <p data-i18n="footer.copyright">&copy; 2025 Tee & Me. All Rights Reserved. Prototype V7.1</p>
    </footer>

    <div id="detailsModal" class="modal">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <button class="modal-close" data-modal-id="detailsModal">&times;</button>
            <h3 id="modalTitle" class="text-xl font-semibold text-pink-700 mb-3">Week Details</h3>
            <div id="modalTimelineCarousel" class="carousel">
                <div class="carousel-inner">
                    </div>
                <button class="carousel-control-prev text-pink-500"><i class="fas fa-chevron-left"></i></button>
                <button class="carousel-control-next text-pink-500"><i class="fas fa-chevron-right"></i></button>
            </div>
            <p id="modalSummary" class="mt-3 text-sm text-gray-600"></p>
        </div>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content w-auto max-w-sm">
            <button class="modal-close" data-modal-id="alertModal">&times;</button>
            <h4 id="alertModalTitle" class="text-lg font-semibold text-pink-700 mb-2">Notification</h4>
            <p id="alertModalMessage" class="text-sm text-gray-700 mb-3"></p>
            <button id="alertModalOk" class="px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-600 w-full" data-i18n="modal.ok">OK</button>
        </div>
    </div>
    
    <div id="playlistModal" class="modal">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2 p-1 aspect-video">
             <button class="modal-close text-white bg-black/30 rounded-full w-8 h-8 flex items-center justify-center -top-2 -right-2" data-modal-id="playlistModal">&times;</button>
            <iframe id="playlistFrame" class="w-full h-full" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
    </div>

    <button id="playlistFab" class="p-3 bg-pink-500 text-white rounded-full shadow-lg hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:ring-opacity-75">
        <i class="fas fa-music fa-lg"></i>
    </button>

    <script>
        // Attempt to load translations from an external file
        // In a real scenario, xh_translations.js would be in the same directory or specified path
        const translationsScript = document.createElement('script');
        translationsScript.src = 'xh_translations.js'; // This will likely 404 in this environment
        translationsScript.onerror = function() {
            console.warn('xh_translations.js not found. Using embedded fallback Xhosa translations.');
            // If xh_translations.js is not found, i18next will use the 'xh' resources defined below if any.
            // If no 'xh' resources are defined below, it will fallback to 'en'.
            // For this demo, we will define a minimal xhosaTranslations object directly.
            if (typeof window.xhosaTranslations === 'undefined') {
                window.xhosaTranslations = { /* Minimal fallback if file fails and not defined below */
                    siteTitle: "Tee & Mna - Ibali Lethu (Fallback)",
                };
            }
            // Re-initialize i18next if it was already initialized without xhosa if needed,
            // or ensure initialization happens after this potential load.
            // For simplicity, we'll assume i18next init in initializeApp handles this.
        };
        document.head.appendChild(translationsScript);


        const relationshipData = {
            playlistUrl: "https://www.youtube.com/embed/playlist?list=PL4o29bINVT4EG_y-k5jGoOu3-Am8Nmmd2", // Example playlist
            photoFileNames: Array.from({length: 12}, (_, i) => `photo${i + 1}.jpg`), // Assumes photo1.jpg to photo12.jpg in assets/photos/
            weeks: [
                {
                    weekNumber: 1, startDate: "2024-01-01", summaryKey: "week1Summary",
                    contributions: {
                        salatiso: { affection: 8, support: 7, communication: 9, food: 5, safety: 8, finances: 600, chores: 4, planning: 7, notesKey: "week1SalatisoNotes" },
                        tee: { affection: 9, support: 8, communication: 8, food: 7, safety: 9, finances: 500, chores: 6, planning: 6, notesKey: "week1TeeNotes" }
                    },
                    events: [
                        { type: "event", textKey: "eventWeek1FirstDate", originalMessageKey: "originalMsgW1FD" },
                        { type: "music", songTitle: "Perfect", artist: "Ed Sheeran", songUrl: "https://www.youtube.com/watch?v=2Vv-BfVoq4g", sharedBy: "Salatiso", textKey: "musicWeek1Salatiso" }
                    ]
                },
                {
                    weekNumber: 2, startDate: "2024-01-08", summaryKey: "week2Summary",
                    contributions: {
                        salatiso: { affection: 7, support: 8, communication: 7, food: 6, safety: 7, finances: 550, chores: 5, planning: 6, notesKey: "week2SalatisoNotes" },
                        tee: { affection: 8, support: 9, communication: 9, food: 8, safety: 8, finances: 650, chores: 7, planning: 8, notesKey: "week2TeeNotes" }
                    },
                    events: [
                        { type: "event", textKey: "eventWeek2MovieNight", originalMessageKey: "originalMsgW2MN" },
                        { type: "link", textKey: "linkWeek2Article", url: "https://www.example.com/article", sharedBy: "Tee" }
                    ]
                },
                 {
                    weekNumber: 3, startDate: "2024-01-15", summaryKey: "week3Summary",
                    contributions: {
                        salatiso: { affection: 9, support: 9, communication: 8, food: 7, safety: 9, finances: 700, chores: 6, planning: 8, notesKey: "week3SalatisoNotes" },
                        tee: { affection: 9, support: 8, communication: 9, food: 7, safety: 9, finances: 750, chores: 7, planning: 7, notesKey: "week3TeeNotes" }
                    },
                    events: [
                        { type: "event", textKey: "eventWeek3WeekendTrip", originalMessageKey: "originalMsgW3WT" },
                        { type: "music", songTitle: "A Thousand Years", artist: "Christina Perri", songUrl: "https://www.youtube.com/watch?v=rtOvBOTyX00", sharedBy: "Joint", textKey: "musicWeek3Joint" }
                    ]
                },
                {
                    weekNumber: 4, startDate: "2024-01-22", summaryKey: "week4Summary",
                     contributions: {
                        salatiso: { affection: 8, support: 7, communication: 7, food: 5, safety: 8, finances: 620, chores: 5, planning: 6, notesKey: "week4SalatisoNotes" },
                        tee: { affection: 7, support: 8, communication: 8, food: 6, safety: 7, finances: 580, chores: 6, planning: 7, notesKey: "week4TeeNotes" }
                    },
                    events: [ { type: "event", textKey: "eventWeek4QuietDinner", originalMessageKey: "originalMsgW4QD" } ]
                }
                // Add more weeks as needed for robust testing
            ],
            reinforcementWords: [
                { wordKey: "reinforceThankYou", purposeKey: "purposeExpressGratitude", occurrences: { salatiso: [1, 3], tee: [1, 2, 4], joint: [] } },
                { wordKey: "reinforceAppreciate", purposeKey: "purposeAcknowledgeEffort", occurrences: { salatiso: [2], tee: [3, 4], joint: [1] } },
                { wordKey: "reinforceLoveYou", purposeKey: "purposeExpressAffection", occurrences: { salatiso: [1,2,3,4], tee: [1,2,3,4], joint: [] } },
            ],
            feedbackLog: [
                { id: "fb1", sender: "Salatiso", recipient: "Tee", messageKey: "feedback1Initial", timestamp: "2024-01-10T10:00:00Z", status: "responded", responseTime: 3600000 }, // 1 hour
                { id: "fb2", sender: "Tee", recipient: "Salatiso", messageKey: "feedback2Initial", timestamp: "2024-01-12T14:30:00Z", status: "pending", responseTime: null },
            ],
            actionLog: [
                { id: "act1", actor: "Tee", actionTypeKey: "actionApology", detailsKey: "actionDetail1Initial", timestamp: "2024-01-15T14:00:00Z" },
                { id: "act2", actor: "Salatiso", actionTypeKey: "actionBookDate", detailsKey: "actionDetail2Initial", date: "2024-01-20", timestamp: "2024-01-16T10:00:00Z" },
            ],
            travelLog: {
                visited: [
                    { id: "tv1", destinationKey: "destDrakensberg", dates: "2023-07-10 - 2023-07-15", roles: { salatisoKey: "rolePlanner", teeKey: "roleNavigator" }, highlightsKey: "drakensbergHighlights", photos: ["photo3.jpg", "photo4.jpg"] }
                ],
                dream: [
                    { id: "td1", destinationKey: "destParis", notesKey: "parisDreamNotes" }, { id: "td2", destinationKey: "destKyoto", notesKey: "kyotoDreamNotes" }
                ]
            },
            metricsMeta: { // For populating dropdowns and chart labels
                affection: { labelKey: "metric.affection", unit: "/10" },
                support: { labelKey: "metric.support", unit: "/10" },
                communication: { labelKey: "metric.communication", unit: "/10" },
                food: { labelKey: "metric.food", unit: "/10" },
                safety: { labelKey: "metric.safety", unit: "/10" },
                finances: { labelKey: "metric.finances", unit: " ZAR" }, // Assuming ZAR
                chores: { labelKey: "metric.chores", unit: "/10" },
                planning: { labelKey: "metric.planning", unit: "/10" },
                feedbackResponseTime: { labelKey: "metric.feedbackResponse", unit: " hours"}
            }
        };

        const englishTranslations = {
            siteTitle: "Tee & Me - Our Story",
            nav: { overview: "Overview", analysisHub: "Analysis Hub", mediaTravelHub: "Media & Travel", connectResolve: "Connect & Resolve", lifeSyncFun: "LifeSync & Fun" },
            overview: {
                title: "Our Journey Snapshot", dashboard: "Dashboard", affectionLevel: "Affection Level", supportScore: "Support Score",
                foodPrep: "Food Prep", safetySecurity: "Safety/Security", specialSong: "Our Special Song", listen: "Listen",
                quickTimeline: "Quick Timeline", seeDetails: "See Details", imageCarousel: "Shared Moments", dashboardChartTitle: "Initial Weeks Metric Trend"
            },
            analysisHub: {
                title: "Analysis Hub",
                tracking: { title: "Tracking", selectMetric: "Select Metric:" },
                contributions: { title: "Contributions", filterByWeek: "Filter by Week:", parameter: "Parameter", salatiso: "Salatiso", tee: "Tee", notes: "Notes" },
                reinforcement: { title: "Reinforcement", wordAction: "Word/Action", purpose: "Purpose", occurrencesSalatiso: "Salatiso (Weeks)", occurrencesTee: "Tee (Weeks)", occurrencesJoint: "Joint (Weeks)" }
            },
            mediaTravelHub: {
                title: "Media & Travel Hub",
                sharedSongs: { title: "Shared Songs", sharedBy: "Shared by {{user}} in Week {{week}}", listen: "Listen" },
                photoMoments: { title: "Photo Moments" },
                visited: { title: "Visited Places", roles: "Roles:", highlights: "Highlights:", photos: "Photos:" },
                dreamTrips: { title: "Dream Trips", notes: "Notes:" }
            },
            connectResolve: {
                title: "Connect & Resolve",
                feedback: { title: "Feedback", give: "Give Feedback", sender: "Sender", recipient: "Recipient", message: "Message", send: "Send Feedback", logTitle: "Feedback Log", acknowledged: "Acknowledged", acknowledge: "Acknowledge", respondedIn: "Responded in {{duration}}", pending: "Pending" },
                actions: {
                    title: "Actions",
                    apology: { title: "Make an Apology", submit: "Submit Apology" },
                    dissatisfaction: { title: "Express Dissatisfaction", submit: "Submit Concern" },
                    bookDate: { title: "Book a Date", submit: "Propose Date", activity: "Activity", date: "Date" },
                    termination: { title: "Initiate Relationship Termination", reason: "Reason", notes: "Notes", submit: "Initiate", reasonIrreconcilable: "Irreconcilable Differences", reasonGrowingApart: "Growing Apart", reasonOther: "Other (Specify)" }
                },
                logs: { title: "Logs", actionLogTitle: "Action Log" }
            },
            lifeSyncFun: {
                title: "LifeSync & Fun",
                compatibility: {
                    title: "Compatibility",
                    astrology: { title: "Astrology Compatibility", salatisoBday: "Salatiso's Birthday:", teeBday: "Tee's Birthday:", check: "Check Compatibility", result: "{{name1}} ({{zodiac1}}) & {{name2}} ({{zodiac2}}): {{compatibilityText}}" },
                    values: { title: "Values Alignment", desc: "Discover how your core values align." },
                    communication: { title: "Communication Styles", desc: "Understand your communication patterns." },
                    proverbs: { title: "African Proverbs Wisdom Match", desc: "Find wisdom in shared cultural understanding." },
                    startTest: "Start Test", comingSoon: "Coming Soon!"
                },
                quizzes: { title: "Quizzes", comingSoon: "Relationship quizzes coming soon!" },
                reports: { title: "LifeSync Reports", selectPeriod: "Select Period:", generate: "Generate Report", periodLast3Months: "Last 3 Months", periodAllTime: "All Time", featureComingSoon: "Full report generation is a future feature!" }
            },
            weekSummaries: { // Corresponds to summaryKey in relationshipData.weeks
                week1Summary: "Our exciting first week!", week2Summary: "Getting to know each other more.", week3Summary: "First little adventure.", week4Summary: "Settling into a rhythm."
            },
            weekNotes: {
                week1SalatisoNotes: "Felt a real spark.", week1TeeNotes: "Very hopeful and happy.",
                week2SalatisoNotes: "Good conversations.", week2TeeNotes: "Enjoying the company.",
                week3SalatisoNotes: "The trip was amazing!", week3TeeNotes: "Made some great memories.",
                week4SalatisoNotes: "Comfortable and content.", week4TeeNotes: "Feeling secure."
            },
            eventTexts: { // Corresponds to textKey in relationshipData.events
                eventWeek1FirstDate: "Our memorable first date.", musicWeek1Salatiso: "Salatiso shared 'Perfect'.",
                eventWeek2MovieNight: "Cozy movie night in.", linkWeek2Article: "Tee shared an interesting article.",
                eventWeek3WeekendTrip: "Spontaneous weekend trip!", musicWeek3Joint: "We both loved 'A Thousand Years'.",
                eventWeek4QuietDinner: "A lovely quiet dinner at home."
            },
            originalMessages: { // Corresponds to originalMessageKey
                originalMsgW1FD: "Salatiso: 'Tonight was amazing, Tee. Can't wait to see you again.' Tee: 'You too, Salatiso! I had a wonderful time.'",
                originalMsgW2MN: "Tee: 'Movie night at my place? I'll get snacks!' Salatiso: 'Sounds perfect!'",
                originalMsgW3WT: "Salatiso: 'Pack your bags, we're going on an adventure this weekend!' Tee: 'OMG, where?! So excited!'",
                originalMsgW4QD: "Tee: 'Just a simple, lovely dinner tonight. Thanks for cooking, Salatiso.' Salatiso: 'My pleasure, Tee.'"
            },
            reinforcement: {
                reinforceThankYou: "Saying 'Thank You'", purposeExpressGratitude: "To express gratitude and appreciation.",
                reinforceAppreciate: "Using 'I appreciate...'", purposeAcknowledgeEffort: "To acknowledge specific efforts or qualities.",
                reinforceLoveYou: "Saying 'I love you'", purposeExpressAffection: "To affirm love and affection."
            },
            feedbackMessages: { // Corresponds to messageKey in relationshipData.feedbackLog
                feedback1Initial: "I felt a bit unheard yesterday during our discussion about weekend plans.",
                feedback2Initial: "Thank you for taking out the trash without me asking! I really appreciate it."
            },
            actionDetails: { // Corresponds to detailsKey in relationshipData.actionLog
                actionDetail1Initial: "For being late to our coffee meeting. Work ran over, but I should have managed my time better.",
                actionDetail2Initial: "Proposed a picnic at the botanical gardens for Saturday."
            },
            actionTypes: {
                actionApology: "Apology", actionExpressDissatisfaction: "Expressed Dissatisfaction", actionBookDate: "Booked a Date", actionTerminate: "Initiated Termination"
            },
            travel: {
                destDrakensberg: "Drakensberg Mountains", destParis: "Paris, France", destKyoto: "Kyoto, Japan",
                rolePlanner: "Planner", roleNavigator: "Navigator", rolePhotographer: "Photographer",
                drakensbergHighlights: "Amazing hikes, breathtaking views, cozy evenings by the fire.",
                parisDreamNotes: "Romantic walks, Eiffel Tower, Louvre, delicious pastries.",
                kyotoDreamNotes: "Temples, gardens, traditional culture, cherry blossoms."
            },
            metrics: relationshipData.metricsMeta, // Reuse for consistency
            modal: { ok: "OK", detailsTitle: "Week {{weekNumber}} Details" },
            footer: { copyright: "&copy; 2025 Tee & Me. All Rights Reserved. Prototype V7.1" },
            general: {
                salatiso: "Salatiso", tee: "Tee", joint: "Joint/Unspecified",
                error: "Error", success: "Success",
                actionLogged: "Action logged successfully.",
                feedbackSent: "Feedback sent successfully.",
                feedbackAcknowledged: "Feedback acknowledged."
            }
        };

        // Embedded Xhosa translations (minimal, as xh_translations.js might not load)
        // In a real setup, xh_translations.js would contain the full object.
        if (typeof window.xhosaTranslations === 'undefined') {
            window.xhosaTranslations = {
                siteTitle: "Tee & Mna - Ibali Lethu",
                nav: { overview: "Isishwankathelo", analysisHub: "Iziko LoHlalutyo", mediaTravelHub: "Ezosasazo NoHambo", connectResolve: "Qhagamshela & Sombulula", lifeSyncFun: "LifeSync & Ukonwaba" },
                overview: { title: "Imbonakalo Yohambo Lwethu", dashboard: "Ideshibhodi", affectionLevel: "Iqondo Lothando", specialSong: "Ingoma Yethu Ekhethekileyo", listen: "Mamela" },
                weekSummaries: { week1Summary: "Iveki yethu yokuqala eyonwabisayo!", week2Summary: "Sisazana ngakumbi." },
                eventTexts: { eventWeek1FirstDate: "Umhla wethu wokuqala ongenakulibaleka." },
                modal: { ok: "Kulungile", detailsTitle: "Iinkcukacha Zeveki {{weekNumber}}" },
                footer: { copyright: "&copy; 2025 Tee & Mna. Onke Amalungelo Agciniwe. Umzekelo V7.1" },
                general: { salatiso: "uSalatiso", tee: "uTee" }
                // Add more essential translations here if xh_translations.js is expected to fail often
            };
        }


        let i18nInstance;
        let currentLanguage = 'en';
        let dashboardChartInstance, trackingChartInstance;

        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            console.log("App Initializing...");
            setupI18Next();
            adjustLayout();
            window.addEventListener('resize', adjustLayout);
            
            setupNavigation();
            setupSubNavigation();
            setupModals();
            setupCarousels();
            populateAllSelects();

            renderOverviewSection();
            renderAnalysisHub(); // Initial render for default views
            renderMediaTravelHub();
            renderConnectResolveHub();
            renderLifeSyncFunHub();
            
            setupActionForms();
            setupCompatibilityTools();
            setupPlaylistFab();

            document.querySelectorAll('.placeholder-test-btn').forEach(btn => {
                btn.addEventListener('click', () => showCustomAlert(i18nInstance.t('lifeSyncFun.compatibility.comingSoon')));
            });
            document.getElementById('generateReportBtn').addEventListener('click', () => {
                showCustomAlert(i18nInstance.t('lifeSyncFun.reports.featureComingSoon'));
            });

            console.log("App Initialized Successfully.");
        }

        function setupI18Next() {
            i18nInstance = i18next
                .use(i18nextBrowserLanguageDetector)
                .init({
                    debug: true,
                    fallbackLng: 'en',
                    resources: {
                        en: { translation: englishTranslations },
                        xh: { translation: window.xhosaTranslations || englishTranslations } // Fallback to English if xhosa not loaded
                    }
                }, (err, t) => {
                    if (err) return console.error('i18next initialization failed', err);
                    currentLanguage = i18nInstance.language.startsWith('xh') ? 'xh' : 'en';
                    updateContentAll();
                    updateLanguageSwitcher();
                    // After i18n is ready, populate dynamic elements that depend on translations
                    populateAllSelects(); // Repopulate selects with translated labels
                    renderAllDynamicContent(); // Re-render content that might use translated keys
                });

            document.querySelectorAll('.lang-switcher').forEach(button => {
                button.addEventListener('click', (e) => {
                    const lang = e.target.dataset.lang;
                    i18nInstance.changeLanguage(lang, (err, t) => {
                        if (err) return console.error('something went wrong loading', err);
                        currentLanguage = lang;
                        updateContentAll();
                        updateLanguageSwitcher();
                        populateAllSelects(); // Repopulate selects with translated labels
                        renderAllDynamicContent();
                    });
                });
            });
        }
        
        function renderAllDynamicContent() {
            // Call all main render functions again to update with new language
            renderOverviewSection();
            renderAnalysisHub(true); // Pass a flag to re-render charts if necessary
            renderMediaTravelHub();
            renderConnectResolveHub();
            // LifeSyncFunHub might not need full re-render if static text is handled by updateContentAll
        }


        function updateLanguageSwitcher() {
            document.querySelectorAll('.lang-switcher').forEach(btn => {
                btn.classList.toggle('font-bold', btn.dataset.lang === currentLanguage);
                btn.classList.toggle('bg-white/50', btn.dataset.lang === currentLanguage);
                btn.classList.toggle('bg-white/30', btn.dataset.lang !== currentLanguage);
            });
        }

        function updateContentAll() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                // Basic interpolation for {{var}} style placeholders
                let translatedText = i18nInstance.t(key);
                const placeholders = el.dataset.i18nOptions ? JSON.parse(el.dataset.i18nOptions) : {};
                for (const pKey in placeholders) {
                    translatedText = translatedText.replace(`{{${pKey}}}`, placeholders[pKey]);
                }
                el.innerHTML = translatedText; // Using innerHTML for FontAwesome icons, be cautious with user-generated content
            });
             // Update chart titles if they exist and depend on i18n
            if (dashboardChartInstance) {
                dashboardChartInstance.options.plugins.title.text = i18nInstance.t('overview.dashboardChartTitle');
                dashboardChartInstance.update();
            }
            if (trackingChartInstance) {
                const selectedMetricKey = document.getElementById('trackingMetricSelect').value;
                if (selectedMetricKey && relationshipData.metricsMeta[selectedMetricKey]) {
                     trackingChartInstance.options.plugins.title.text = i18nInstance.t(relationshipData.metricsMeta[selectedMetricKey].labelKey);
                     trackingChartInstance.update();
                }
            }
        }

        function adjustLayout() {
            const header = document.querySelector('header');
            const nav = document.querySelector('nav.main-nav');
            const footer = document.querySelector('footer');
            const contentAreaWrapper = document.querySelector('.content-area-wrapper');

            if (!header || !nav || !footer || !contentAreaWrapper) {
                console.error("Layout elements not found for adjustment.");
                return;
            }

            const headerHeight = header.offsetHeight;
            const navHeight = nav.offsetHeight;
            const footerHeight = footer.offsetHeight;

            nav.style.top = `${headerHeight}px`;
            contentAreaWrapper.style.paddingTop = `${headerHeight + navHeight}px`;
            contentAreaWrapper.style.paddingBottom = `${footerHeight}px`;
            contentAreaWrapper.style.height = `100vh`;
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            
            // Set initial active link
            const initialActiveLink = document.querySelector('.nav-link[data-section="overview"]');
            if (initialActiveLink) initialActiveLink.classList.add('bg-white/20', 'font-semibold');


            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetSectionId = link.dataset.section;

                    navLinks.forEach(l => l.classList.remove('bg-white/20', 'font-semibold'));
                    link.classList.add('bg-white/20', 'font-semibold');

                    sections.forEach(section => {
                        if (section.id === targetSectionId) {
                            section.classList.add('active');
                        } else {
                            section.classList.remove('active');
                        }
                    });
                    // If navigating to a section with sub-tabs, ensure the first sub-tab is active
                    const targetSectionEl = document.getElementById(targetSectionId);
                    if (targetSectionEl) {
                        const firstSubNavTab = targetSectionEl.querySelector('.sub-nav-tab');
                        if (firstSubNavTab) {
                            // Deactivate all sub-tabs in this section first
                            targetSectionEl.querySelectorAll('.sub-nav-tab').forEach(t => t.classList.remove('active'));
                            targetSectionEl.querySelectorAll('.sub-content').forEach(sc => sc.classList.remove('active'));
                            // Activate the first one
                            firstSubNavTab.classList.add('active');
                            const firstSubContentId = firstSubNavTab.dataset.subtarget;
                            const firstSubContentEl = targetSectionEl.querySelector(`.sub-content#${firstSubContentId}`);
                            if (firstSubContentEl) firstSubContentEl.classList.add('active');
                        }
                    }
                });
            });
        }

        function setupSubNavigation() {
            document.querySelectorAll('.content-section').forEach(section => {
                const subNavTabs = section.querySelectorAll('.sub-nav-tab');
                const subContents = section.querySelectorAll('.sub-content');

                subNavTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const subTargetId = tab.dataset.subtarget;
                        subNavTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');

                        subContents.forEach(content => {
                            content.classList.toggle('active', content.id === subTargetId);
                        });
                    });
                });
            });
        }

        function setupModals() {
            document.querySelectorAll('.modal-close, .modal').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target === el || el.classList.contains('modal-close')) { // Close if backdrop or close button clicked
                        const modalId = el.dataset.modalId || el.closest('.modal').id;
                        if (modalId) {
                            const modal = document.getElementById(modalId);
                            if (modal) modal.style.display = 'none';
                            if (modalId === 'playlistModal') { // Stop video when closing playlist
                                const iframe = document.getElementById('playlistFrame');
                                if (iframe) iframe.src = iframe.src; // Resets the iframe
                            }
                        }
                    }
                });
            });
            document.getElementById('alertModalOk').addEventListener('click', () => {
                document.getElementById('alertModal').style.display = 'none';
            });
        }
        
        function showCustomAlert(message, title = i18nInstance.t('general.notification') || "Notification") {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }

        function setupCarousels() {
            document.querySelectorAll('.carousel').forEach(carousel => {
                const inner = carousel.querySelector('.carousel-inner');
                const prevButton = carousel.querySelector('.carousel-control-prev');
                const nextButton = carousel.querySelector('.carousel-control-next');
                let currentIndex = 0;
                let items; // Will be populated when content is rendered

                function updateCarousel() {
                    items = inner.querySelectorAll('.carousel-item'); // Re-query items
                    if (!items || items.length === 0) return;
                    const itemWidth = items[0].offsetWidth + parseFloat(getComputedStyle(items[0]).marginRight) + parseFloat(getComputedStyle(items[0]).marginLeft);
                    
                    // For multi-item carousels like QuickTimeline
                    if (carousel.id === 'quickTimelineCarousel') {
                         const visibleItems = Math.floor(carousel.offsetWidth / itemWidth);
                         const maxIndex = Math.max(0, items.length - visibleItems);
                         currentIndex = Math.min(currentIndex, maxIndex);
                         currentIndex = Math.max(0, currentIndex);
                         inner.style.transform = `translateX(-${currentIndex * itemWidth}px)`;

                    } else { // For single full-width item carousels
                        inner.style.transform = `translateX(-${currentIndex * 100}%)`;
                    }

                    if (prevButton) prevButton.disabled = currentIndex === 0;
                    if (nextButton) {
                        if (carousel.id === 'quickTimelineCarousel') {
                            const visibleItems = Math.floor(carousel.offsetWidth / itemWidth);
                            nextButton.disabled = currentIndex >= items.length - visibleItems;
                        } else {
                            nextButton.disabled = currentIndex === items.length - 1;
                        }
                    }
                }
                
                carousel.updateCarouselItems = updateCarousel; // Expose update function

                if (prevButton) {
                    prevButton.addEventListener('click', () => {
                        if (currentIndex > 0) {
                            currentIndex--;
                            updateCarousel();
                        }
                    });
                }
                if (nextButton) {
                    nextButton.addEventListener('click', () => {
                        items = inner.querySelectorAll('.carousel-item'); // Re-query items
                        if (!items || items.length === 0) return;
                        
                        if (carousel.id === 'quickTimelineCarousel') {
                            const itemWidth = items[0].offsetWidth + parseFloat(getComputedStyle(items[0]).marginRight) + parseFloat(getComputedStyle(items[0]).marginLeft);
                            const visibleItems = Math.floor(carousel.offsetWidth / itemWidth);
                            if (currentIndex < items.length - visibleItems) {
                                currentIndex++;
                            }
                        } else {
                             if (currentIndex < items.length - 1) {
                                currentIndex++;
                            }
                        }
                        updateCarousel();
                    });
                }
                // Initial setup
                // updateCarousel(); // Call this after items are populated
                // window.addEventListener('resize', updateCarousel); // Add resize listener if needed for responsive item widths
            });
        }
        
        function populateAllSelects() {
            // Tracking Metric Select
            const trackingMetricSelect = document.getElementById('trackingMetricSelect');
            if (trackingMetricSelect) {
                trackingMetricSelect.innerHTML = ''; // Clear existing
                Object.keys(relationshipData.metricsMeta).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = i18nInstance.t(relationshipData.metricsMeta[key].labelKey);
                    trackingMetricSelect.appendChild(option);
                });
                trackingMetricSelect.addEventListener('change', () => updateTrackingChart());
            }

            // Contribution Filter Week Select
            const contributionFilterWeek = document.getElementById('contributionFilterWeek');
            if (contributionFilterWeek) {
                contributionFilterWeek.innerHTML = ''; // Clear existing
                relationshipData.weeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.weekNumber;
                    option.textContent = `${i18nInstance.t('general.week') || 'Week'} ${week.weekNumber} (${week.startDate})`;
                    contributionFilterWeek.appendChild(option);
                });
                contributionFilterWeek.addEventListener('change', () => renderContributionsTable());
            }
        }

        function renderOverviewSection() {
            // Metrics - simplified for now, can be calculated averages later
            // document.getElementById('metricAffection').textContent = '8.5/10'; // Example
            // ...

            renderOverviewTimelineCarousel();
            renderOverviewImageCarousel();
            updateDashboardChart();
        }

        function renderOverviewTimelineCarousel() {
            const carouselInner = document.querySelector('#quickTimelineCarousel .carousel-inner');
            if (!carouselInner) return;
            carouselInner.innerHTML = ''; // Clear existing
            relationshipData.weeks.slice(0, 8).forEach(week => { // Show first 8 weeks for example
                const item = document.createElement('div');
                item.className = 'carousel-item bg-white p-3 rounded-lg shadow text-sm flex-shrink-0'; // Added flex-shrink-0
                item.innerHTML = `
                    <h4 class="font-semibold text-pink-700">${i18nInstance.t('general.week') || 'Week'} ${week.weekNumber} (${week.startDate})</h4>
                    <p class="text-gray-600 mt-1 truncate">${i18nInstance.t(week.summaryKey)}</p>
                    <button class="details-btn mt-2 text-xs text-pink-500 hover:text-pink-700" data-week="${week.weekNumber}" data-i18n="overview.seeDetails">See Details</button>
                `;
                carouselInner.appendChild(item);
            });
            // Re-initialize or update carousel logic
            const carousel = document.getElementById('quickTimelineCarousel');
            if (carousel && carousel.updateCarouselItems) {
                 setTimeout(() => carousel.updateCarouselItems(), 0); // Ensure items are in DOM
            }
            
            document.querySelectorAll('#quickTimelineCarousel .details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => showDetailsModal(parseInt(e.target.dataset.week)));
            });
        }

        function renderOverviewImageCarousel() {
            const carouselInner = document.querySelector('#overviewImageCarousel .carousel-inner');
            if (!carouselInner) return;
            carouselInner.innerHTML = '';
            const shuffledPhotos = [...relationshipData.photoFileNames].sort(() => 0.5 - Math.random()).slice(0, 5); // Show 5 random
            shuffledPhotos.forEach(fileName => {
                const item = document.createElement('div');
                item.className = 'carousel-item h-full';
                item.innerHTML = `<img src="assets/photos/${fileName}" alt="Shared Moment" class="w-full h-full object-cover rounded-lg">`;
                carouselInner.appendChild(item);
            });
             const carousel = document.getElementById('overviewImageCarousel');
            if (carousel && carousel.updateCarouselItems) {
                 setTimeout(() => carousel.updateCarouselItems(), 0);
            }
            // Autoplay logic (simple version)
            let autoPlayIndex = 0;
            setInterval(() => {
                const items = carouselInner.querySelectorAll('.carousel-item');
                if (items.length > 0) {
                    autoPlayIndex = (autoPlayIndex + 1) % items.length;
                    inner.style.transform = `translateX(-${autoPlayIndex * 100}%)`;
                }
            }, 5000); // Change image every 5 seconds
        }
        
        function updateDashboardChart() {
            const ctx = document.getElementById('dashboardChart')?.getContext('2d');
            if (!ctx) return;

            const initialWeeksData = relationshipData.weeks.slice(0, 4); // First 4 weeks
            const labels = initialWeeksData.map(w => `${i18nInstance.t('general.week') || 'Week'} ${w.weekNumber}`);
            const affectionDataS = initialWeeksData.map(w => w.contributions.salatiso.affection);
            const affectionDataT = initialWeeksData.map(w => w.contributions.tee.affection);

            if (dashboardChartInstance) dashboardChartInstance.destroy();
            dashboardChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: i18nInstance.t('general.salatiso') + ' ' + i18nInstance.t(relationshipData.metricsMeta.affection.labelKey),
                            data: affectionDataS,
                            borderColor: 'rgb(236, 72, 153)', // pink-500
                            tension: 0.1
                        },
                        {
                            label: i18nInstance.t('general.tee') + ' ' + i18nInstance.t(relationshipData.metricsMeta.affection.labelKey),
                            data: affectionDataT,
                            borderColor: 'rgb(244, 114, 182)', // pink-400
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: i18nInstance.t('overview.dashboardChartTitle') },
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 10} } }
                    },
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            });
        }

        function renderAnalysisHub(forceChartRender = false) {
            renderContributionsTable();
            renderReinforcementTable();
            if (forceChartRender || !trackingChartInstance) { // Avoid re-rendering chart unnecessarily unless forced or not initialized
                updateTrackingChart();
            }
        }

        function updateTrackingChart() {
            const ctx = document.getElementById('trackingChart')?.getContext('2d');
            const selectedMetric = document.getElementById('trackingMetricSelect').value;
            if (!ctx || !selectedMetric) return;

            const metricMeta = relationshipData.metricsMeta[selectedMetric];
            let labels = relationshipData.weeks.map(w => `${i18nInstance.t('general.week') || 'Week'} ${w.weekNumber}`);
            let dataS, dataT;

            if (selectedMetric === 'feedbackResponseTime') {
                // Special handling for feedback response time (average per week, for example)
                // This is a simplified placeholder. Real calculation would be complex.
                dataS = relationshipData.weeks.map(() => Math.random() * 5 + 1); // Random data 1-6 hours
                dataT = relationshipData.weeks.map(() => Math.random() * 5 + 1);
            } else {
                dataS = relationshipData.weeks.map(w => w.contributions.salatiso[selectedMetric] || 0);
                dataT = relationshipData.weeks.map(w => w.contributions.tee[selectedMetric] || 0);
            }
            
            const chartType = (selectedMetric === 'finances') ? 'bar' : 'line';

            if (trackingChartInstance) trackingChartInstance.destroy();
            trackingChartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${i18nInstance.t('general.salatiso')} (${i18nInstance.t(metricMeta.labelKey)})`,
                            data: dataS,
                            borderColor: 'rgb(219, 39, 119)', // pink-600
                            backgroundColor: 'rgba(219, 39, 119, 0.5)',
                            tension: 0.1
                        },
                        {
                            label: `${i18nInstance.t('general.tee')} (${i18nInstance.t(metricMeta.labelKey)})`,
                            data: dataT,
                            borderColor: 'rgb(244, 114, 182)', // pink-400
                            backgroundColor: 'rgba(244, 114, 182, 0.5)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: i18nInstance.t(metricMeta.labelKey) },
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 10} } }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        function renderContributionsTable() {
            const tbody = document.getElementById('contributionsTableBody');
            const selectedWeekNum = parseInt(document.getElementById('contributionFilterWeek').value);
            if (!tbody || !selectedWeekNum) return;

            const weekData = relationshipData.weeks.find(w => w.weekNumber === selectedWeekNum);
            if (!weekData) return;

            tbody.innerHTML = '';
            const parameters = Object.keys(relationshipData.metricsMeta).filter(k => k !== 'feedbackResponseTime'); // Exclude feedback time

            parameters.forEach(param => {
                const row = tbody.insertRow();
                row.insertCell().textContent = i18nInstance.t(relationshipData.metricsMeta[param].labelKey);
                row.insertCell().textContent = `${weekData.contributions.salatiso[param] || 'N/A'} ${relationshipData.metricsMeta[param].unit || ''}`;
                row.insertCell().textContent = `${weekData.contributions.tee[param] || 'N/A'} ${relationshipData.metricsMeta[param].unit || ''}`;
                const notesS = weekData.contributions.salatiso.notesKey ? i18nInstance.t(weekData.contributions.salatiso.notesKey) : '';
                const notesT = weekData.contributions.tee.notesKey ? i18nInstance.t(weekData.contributions.tee.notesKey) : '';
                row.insertCell().textContent = `S: ${notesS || '-'} T: ${notesT || '-'}`;
            });
        }

        function renderReinforcementTable() {
            const tbody = document.getElementById('reinforcementTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            relationshipData.reinforcementWords.forEach(word => {
                const row = tbody.insertRow();
                row.insertCell().textContent = i18nInstance.t(word.wordKey);
                row.insertCell().textContent = i18nInstance.t(word.purposeKey);
                row.insertCell().textContent = word.occurrences.salatiso.join(', ') || '-';
                row.insertCell().textContent = word.occurrences.tee.join(', ') || '-';
                row.insertCell().textContent = word.occurrences.joint.join(', ') || '-';
            });
        }
        
        function renderMediaTravelHub() {
            renderSharedSongs();
            renderPhotoMoments();
            renderTravelLog();
        }

        function renderSharedSongs() {
            const list = document.getElementById('sharedSongsList');
            if (!list) return;
            list.innerHTML = '';
            relationshipData.weeks.forEach(week => {
                week.events.filter(e => e.type === 'music').forEach(song => {
                    const li = document.createElement('li');
                    li.className = 'p-2 bg-rose-50 rounded-md shadow-sm text-sm';
                    li.innerHTML = `
                        <span class="font-semibold text-rose-700">${song.songTitle}</span> ${song.artist ? 'by ' + song.artist : ''}
                        <br>
                        <span class="text-xs text-gray-600">${i18nInstance.t('mediaTravelHub.sharedSongs.sharedBy', { user: i18nInstance.t(`general.${song.sharedBy.toLowerCase()}`) || song.sharedBy, week: week.weekNumber })}</span>
                        <a href="${song.songUrl}" target="_blank" class="ml-2 text-xs text-pink-500 hover:text-pink-700">${i18nInstance.t('mediaTravelHub.sharedSongs.listen')} <i class="fas fa-play-circle"></i></a>
                    `;
                    list.appendChild(li);
                });
            });
        }

        function renderPhotoMoments() {
            const grid = document.getElementById('photoMomentsGrid');
            if (!grid) return;
            grid.innerHTML = '';
            relationshipData.photoFileNames.forEach(fileName => {
                const img = document.createElement('img');
                img.src = `assets/photos/${fileName}`;
                img.alt = "Photo moment";
                img.className = "w-full h-auto object-cover rounded-md shadow aspect-square"; // Added aspect-square
                grid.appendChild(img);
            });
        }

        function renderTravelLog() {
            const visitedList = document.getElementById('visitedTripsList');
            const dreamList = document.getElementById('dreamTripsList');
            if (!visitedList || !dreamList) return;

            visitedList.innerHTML = '';
            relationshipData.travelLog.visited.forEach(trip => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-rose-50 rounded-lg shadow text-sm';
                item.innerHTML = `
                    <h4 class="font-semibold text-rose-700">${i18nInstance.t(trip.destinationKey)} (${trip.dates})</h4>
                    <p><strong>${i18nInstance.t('mediaTravelHub.visited.roles')}</strong> S: ${i18nInstance.t(trip.roles.salatisoKey)}, T: ${i18nInstance.t(trip.roles.teeKey)}</p>
                    <p><strong>${i18nInstance.t('mediaTravelHub.visited.highlights')}</strong> ${i18nInstance.t(trip.highlightsKey)}</p>
                    ${trip.photos && trip.photos.length > 0 ? `<p class="mt-1"><strong>${i18nInstance.t('mediaTravelHub.visited.photos')}</strong></p><div class="flex gap-1 mt-1">${trip.photos.map(p => `<img src="assets/photos/${p}" class="w-16 h-16 object-cover rounded">`).join('')}</div>` : ''}
                `;
                visitedList.appendChild(item);
            });

            dreamList.innerHTML = '';
            relationshipData.travelLog.dream.forEach(trip => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-rose-50 rounded-lg shadow text-sm';
                item.innerHTML = `
                    <h4 class="font-semibold text-rose-700">${i18nInstance.t(trip.destinationKey)}</h4>
                    <p><strong>${i18nInstance.t('mediaTravelHub.dreamTrips.notes')}</strong> ${i18nInstance.t(trip.notesKey)}</p>
                `;
                dreamList.appendChild(item);
            });
        }
        
        function renderConnectResolveHub() {
            renderFeedbackLog();
            renderActionLog();
        }

        document.getElementById('feedbackForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const sender = document.getElementById('feedbackSender').value;
            const recipient = document.getElementById('feedbackRecipient').value;
            const messageText = document.getElementById('feedbackMessage').value;
            
            if (!messageText.trim()) {
                showCustomAlert("Message cannot be empty.");
                return;
            }

            const newFeedback = {
                id: `fb${Date.now()}`,
                sender,
                recipient,
                messageKey: `customFeedback${Date.now()}`, // Need to store custom text, not just key
                messageText: messageText, // Store the actual text
                timestamp: new Date().toISOString(),
                status: 'pending',
                responseTime: null
            };
            // Add to englishTranslations for dynamic display if needed, or handle directly
            englishTranslations.feedbackMessages[newFeedback.messageKey] = messageText;
            // For Xhosa, it would ideally be translated or shown in English
            if (window.xhosaTranslations) window.xhosaTranslations.feedbackMessages[newFeedback.messageKey] = messageText + " (IsiXhosa: Kufuneka iguqulwe)";


            relationshipData.feedbackLog.push(newFeedback);
            renderFeedbackLog();
            this.reset();
            showCustomAlert(i18nInstance.t('general.feedbackSent'));
        });

        function renderFeedbackLog() {
            const container = document.getElementById('feedbackLogContainer');
            if (!container) return;
            container.innerHTML = '';
            [...relationshipData.feedbackLog].reverse().forEach(fb => { // Show newest first
                const item = document.createElement('div');
                item.className = 'p-2 border border-rose-200 rounded-md text-xs';
                const message = fb.messageText || i18nInstance.t(fb.messageKey); // Use stored text or key
                let responseInfo = '';
                if (fb.status === 'responded' && fb.responseTime) {
                    const hours = Math.floor(fb.responseTime / 3600000);
                    const minutes = Math.floor((fb.responseTime % 3600000) / 60000);
                    responseInfo = `<span class="text-green-600">${i18nInstance.t('connectResolve.feedback.respondedIn', { duration: `${hours}h ${minutes}m` })}</span>`;
                } else if (fb.status === 'pending') {
                    responseInfo = `<button class="acknowledge-feedback-btn text-blue-500 hover:underline" data-id="${fb.id}">${i18nInstance.t('connectResolve.feedback.acknowledge')}</button>`;
                }

                item.innerHTML = `
                    <p><strong>${i18nInstance.t('general.from') || 'From'}:</strong> ${i18nInstance.t(`general.${fb.sender.toLowerCase()}`)} <strong>${i18nInstance.t('general.to') || 'To'}:</strong> ${i18nInstance.t(`general.${fb.recipient.toLowerCase()}`)}</p>
                    <p class="my-1">"${message}"</p>
                    <p class="text-gray-500">${new Date(fb.timestamp).toLocaleString()} - ${responseInfo}</p>
                `;
                container.appendChild(item);
            });
            
            document.querySelectorAll('.acknowledge-feedback-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const feedbackId = e.target.dataset.id;
                    const feedbackItem = relationshipData.feedbackLog.find(item => item.id === feedbackId);
                    if (feedbackItem) {
                        feedbackItem.status = 'responded';
                        feedbackItem.responseTime = Date.now() - new Date(feedbackItem.timestamp).getTime();
                        renderFeedbackLog();
                        showCustomAlert(i18nInstance.t('general.feedbackAcknowledged'));
                    }
                });
            });
        }
        
        function setupActionForms() {
            const forms = [
                { id: 'apologyForm', typeKey: 'actionApology', fields: ['apologyActor', 'apologyMessage'] },
                { id: 'dissatisfactionForm', typeKey: 'actionExpressDissatisfaction', fields: ['dissatisfactionActor', 'dissatisfactionMessage'] },
                { id: 'bookDateForm', typeKey: 'actionBookDate', fields: ['bookDateActor', 'bookDateActivity', 'bookDateDate'] },
                { id: 'terminationForm', typeKey: 'actionTerminate', fields: ['terminationActor', 'terminationReason', 'terminationNotes'] }
            ];

            forms.forEach(formInfo => {
                const formElement = document.getElementById(formInfo.id);
                if (formElement) {
                    formElement.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const action = {
                            id: `act${Date.now()}`,
                            timestamp: new Date().toISOString(),
                            actionTypeKey: formInfo.typeKey
                        };
                        let detailsText = "";
                        formInfo.fields.forEach(fieldId => {
                            const fieldElement = document.getElementById(fieldId);
                            if (fieldElement) {
                                const fieldName = fieldId.replace(/^(apology|dissatisfaction|bookDate|termination)/, '').toLowerCase();
                                action[fieldName] = fieldElement.value;
                                if (fieldId.includes('Message') || fieldId.includes('Activity') || fieldId.includes('Notes')) {
                                    detailsText += `${fieldElement.value} `;
                                } else if (fieldId.includes('Date')) {
                                    detailsText += `Date: ${fieldElement.value} `;
                                } else if (fieldId.includes('Reason')) {
                                    const selectedOption = fieldElement.options[fieldElement.selectedIndex];
                                    detailsText += `Reason: ${selectedOption.dataset.i18n ? i18nInstance.t(selectedOption.dataset.i18n) : selectedOption.textContent} `;
                                }
                            }
                        });
                        action.detailsText = detailsText.trim(); // Store compiled details
                        action.detailsKey = `customActionDetail${Date.now()}`; // For i18n if needed, though text is stored
                        englishTranslations.actionDetails[action.detailsKey] = action.detailsText;
                        if(window.xhosaTranslations) window.xhosaTranslations.actionDetails[action.detailsKey] = action.detailsText  + " (IsiXhosa: Kufuneka iguqulwe)";


                        if (formInfo.id === 'terminationForm') {
                            // Simple confirmation for termination
                            if (!confirm(i18nInstance.t('connectResolve.actions.termination.confirm') || "Are you sure you want to log this action? This is a serious step.")) {
                                return;
                            }
                        }
                        
                        relationshipData.actionLog.push(action);
                        renderActionLog();
                        formElement.reset();
                        showCustomAlert(i18nInstance.t('general.actionLogged'));
                    });
                }
            });
        }

        function renderActionLog() {
            const container = document.getElementById('actionLogContainer');
            if (!container) return;
            container.innerHTML = '';
            [...relationshipData.actionLog].reverse().forEach(log => { // Show newest first
                const item = document.createElement('div');
                item.className = 'p-2 border border-rose-200 rounded-md text-xs';
                const actor = log.actor || log.apologyactor || log.dissatisfactionactor || log.bookdateactor || log.terminationactor; // Handle variations from form field names
                const details = log.detailsText || i18nInstance.t(log.detailsKey);
                item.innerHTML = `
                    <p><strong>${i18nInstance.t(log.actionTypeKey)}</strong> ${i18nInstance.t('general.by') || 'by'} ${i18nInstance.t(`general.${actor.toLowerCase()}`)}</p>
                    <p class="my-1">"${details}"</p>
                    <p class="text-gray-500">${new Date(log.timestamp).toLocaleString()}</p>
                `;
                container.appendChild(item);
            });
        }

        function renderLifeSyncFunHub() {
            // Astrology is handled by its own setup
        }
        
        function setupCompatibilityTools() {
            const checkAstrologyBtn = document.getElementById('checkAstrology');
            if (checkAstrologyBtn) {
                checkAstrologyBtn.addEventListener('click', () => {
                    const bdayS = document.getElementById('salatisoBirthday').value;
                    const bdayT = document.getElementById('teeBirthday').value;
                    const resultDiv = document.getElementById('astrologyResult');
                    if (!bdayS || !bdayT || !resultDiv) {
                        resultDiv.textContent = "Please enter both birthdays.";
                        return;
                    }
                    const zodiacS = getZodiacSign(new Date(bdayS));
                    const zodiacT = getZodiacSign(new Date(bdayT));
                    // Super simple compatibility text
                    const compatibilityText = `(${zodiacS}) and (${zodiacT}) can make a great team if they appreciate their differences!`;
                    resultDiv.textContent = i18nInstance.t('lifeSyncFun.compatibility.astrology.result', {
                        name1: i18nInstance.t('general.salatiso'), zodiac1: zodiacS,
                        name2: i18nInstance.t('general.tee'), zodiac2: zodiacT,
                        compatibilityText: compatibilityText // This part is not i18n'd, but could be
                    });
                });
            }
        }

        function getZodiacSign(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "Aquarius";
            if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "Pisces";
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "Aries";
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "Taurus";
            if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "Gemini";
            if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "Cancer";
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "Leo";
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "Virgo";
            if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "Libra";
            if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "Scorpio";
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "Sagittarius";
            if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return "Capricorn";
            return "Unknown";
        }

        function showDetailsModal(weekNumber) {
            const week = relationshipData.weeks.find(w => w.weekNumber === weekNumber);
            if (!week) return;

            document.getElementById('modalTitle').textContent = i18nInstance.t('modal.detailsTitle', { weekNumber: week.weekNumber });
            document.getElementById('modalSummary').textContent = i18nInstance.t(week.summaryKey);
            
            const modalCarouselInner = document.querySelector('#modalTimelineCarousel .carousel-inner');
            modalCarouselInner.innerHTML = ''; // Clear previous
            
            if (week.events && week.events.length > 0) {
                week.events.forEach(event => {
                    const item = document.createElement('div');
                    item.className = 'carousel-item p-2 text-sm'; // Full width for modal items
                    let eventHtml = `<h5 class="font-semibold text-pink-600">${i18nInstance.t(event.textKey)}</h5>`;
                    if (event.originalMessageKey) {
                        eventHtml += `<p class="text-xs text-gray-500 mt-1 whitespace-pre-wrap"><em>${i18nInstance.t(event.originalMessageKey)}</em></p>`;
                    }
                    if (event.type === 'music') {
                        eventHtml += `<p class="text-xs mt-1">${event.songTitle} by ${event.artist} (<a href="${event.songUrl}" target="_blank" class="text-pink-500">Listen</a>)</p>`;
                    }
                    if (event.type === 'link') {
                         eventHtml += `<p class="text-xs mt-1"><a href="${event.url}" target="_blank" class="text-pink-500">View Link</a></p>`;
                    }
                    item.innerHTML = eventHtml;
                    modalCarouselInner.appendChild(item);
                });
            } else {
                modalCarouselInner.innerHTML = `<div class="carousel-item p-2 text-sm">${i18nInstance.t('general.noEvents') || 'No specific events logged for this week.'}</div>`;
            }
            
            const modalCarousel = document.getElementById('modalTimelineCarousel');
            if (modalCarousel && modalCarousel.updateCarouselItems) {
                setTimeout(() => modalCarousel.updateCarouselItems(), 0); // Ensure items are in DOM
            }

            document.getElementById('detailsModal').style.display = 'flex';
        }
        
        function setupPlaylistFab() {
            const fab = document.getElementById('playlistFab');
            const modal = document.getElementById('playlistModal');
            const iframe = document.getElementById('playlistFrame');
            if (fab && modal && iframe) {
                fab.addEventListener('click', () => {
                    iframe.src = relationshipData.playlistUrl;
                    modal.style.display = 'flex';
                });
            }
        }

    </script>
</body>
</html>
